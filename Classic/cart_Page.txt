<!-- 
  * @author     Mariateresa Mollica (m.mollica@bit2win.com)
  * @since      Oct 05, 2016
  * @desc       Controller Class for ITA_IFM_VFP059_AM_Cart;
  * @history    Oct 05, 2016 – Mariateresa Mollica – Class creation 
-->
<apex:page standardStyleSheets="true" docType="html-5.0" sidebar="false" showheader="false" controller="ITA_IFM_VFC059_AM_Cart"> 
 
    <!--### CSS ###-->
    <apex:stylesheet value="{!URLFOR($Resource.ITA_IFM_AppMobile_jQuery,    '/jQuery/css/jquery-ui.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ITA_IFM_AppMobile,           '/assets/styles/salesforce-lightning-design-system-vf.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.ITA_IFM_AppMobile_Carousel,  '/owl-carousel/owl.carousel.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.ITA_IFM_AppMobile_Carousel,  '/owl-carousel/owl.theme.css')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ITA_IFM_AppMobile_icons, '/icon_script/icons_script.js')}"/>
    <apex:stylesheet value="{!$Resource.ITA_IFM_AppMobile_CSS}" />    
    <!--### SCRIPT ###-->    
    <apex:includeScript value="{!URLFOR($Resource.ITA_IFM_AppMobile_jQuery, '/jQuery/script/jquery-1.11.3.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ITA_IFM_AppMobile_jQuery, '/jQuery/script/jquery-ui.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.ITA_IFM_AppMobile_Carousel,'/owl-carousel/owl.carousel.js')}"/>
    
    <style>  

      	.AM_border
      	{
  		    border-left: solid 2px #ebebeb;
    		margin-bottom: 1%;
    		margin-top: 1%;
      	}
    	.AM_margin
    	{
		    margin-left: 2%;
    		margin-right: 2%;
    		margin-top: 2%;
    		margin-bottom: 2%;
    	}
    	.AM_detailContainer
    	{
    		background-color: white!important; 
    		color: #7f8fa6
    	}
    	.AM_fontSize1x
    	{
    		font-size: 1rem;
    	}
    	#AM_categoryTabs
    	{
    		max-height: 300px;
    		overflow-y: scroll;
    	}
    	.fa-exclamation 
    	{ 
    		margin-right:10%;
    	} 
	    #AM_configurationContainer
	    {
	    	background-color: white;
	    	height: 370px!important;
	    }
    	.AM_successTheme
    	{
		    padding: 3%;
    		border-radius: 5px;
    	}
    	.AM_childAttrTable
    	{ 
		    margin-top: 1%;
		    margin-bottom: 1%;
		    border: 2px solid #e5e8ee; 
    	}
        .AM_buttonGroup
        {
        	margin-left: 25%!important;
        }
    	.AM_borderRed
    	{
    		border-color:#c23934!important;
    	}
    	.AM_borderYellow
    	{
    		border-color:#ffb75d!important;
    	}
    	.AM_borderMess
    	{
    		border: 3px solid;
		    margin: 1%;
		    padding: 2%;
    	}
    	#AM_categoryName
    	{
    		margin-left: 5%;
    		text-transform: uppercase;
    		font-size: large; 
    	}
        .AM_productImg 
        {
            background-color: white;
            padding: 5%;
        }
        .AM_thumbnail 
        {
            background-color: white!important; 
            border: 1px solid #d8dde6!important;  
            margin-top: 3%!important;
            margin-left: 3%!important;
            margin-right: 0%!important;
            margin-bottom: 3%!important;
        }
        .AM_thumbnailSummary 
        {
        	background-color: white!important; 
            border: 1px solid #d8dde6!important;  
            margin-top: 1%!important;
            margin-left: 1%!important;
            margin-right: 0%!important;
            margin-bottom: 1%!important;
        }
        .ui-autocomplete
        {
            background-color: white!important;
            font-size: 20px!important;
            max-height: 150px!important;
            overflow-y: auto!important;
        }
        #AM_searchBar
        {
            font-size: 20px!important;
        } 
        .AM_color
        {
            background-color : white;
            padding: 5%;
        }

        /*********************************************************/
        /*                  CSS - BIT2PUBLISH                    */
        /*********************************************************/

        /**********************  ELETTRICO  **********************/
        .AM_borderELE
        { 
            background-color: #ffc63e;
            color: white!important;
        }
        .AM_colorELE
        {
            background-color : #ffc63e!important;
            color: white;
        }
        .AM_ELE /* text uppercase */
        {
            color: white; 
            text-transform: uppercase; 
            margin-left: 2%;
            margin-right: 2%;
        }
        .AM_ELE2/* text uppercase */
        {
            color: #ffc63e; 
            text-transform: uppercase; 
            margin-left: 2%;
            margin-right: 2%;
        }
        .AM_boxInfoELE
        { 
            color: #ffc63e;
            border-radius: 0px!important;
        }
         /************************  GAS  ************************/
        .AM_borderGAS
        {  
            background-color: #f15d22;
            color: white!important;
        }
        .AM_colorGAS
        {
            background-color : #f15d22!important;
            color: white;
        } 
        .AM_GAS 
        {
            color: white; 
            text-transform: uppercase; 
            margin-left: 2%;
            margin-right: 2%;
        }
        .AM_GAS2 
        {
            color: #f15d22; 
            text-transform: uppercase; 
            margin-left: 2%;
            margin-right: 2%;
        }
        .AM_boxInfoGAS
        { 
            color: #f15d22;
            border-radius: 0px!important;
        }
        /*************************/
        .AM_alertContainer
        {
            width: 20%!important;
        }
        .AM_bumpLeft
        { 
            margin-right: 10%!important;
        }
        #AM_header
        {
            margin-top: 2%;
            margin-bottom: 2%;
        }
        #FAKE_HEADER, #FAKE_FOOTER
        {
            height:75px; 
            background-color : #55be5a;
        }
        #AM_reset
        { 
            margin-left: -50%;    
        }
        #AM_logo
        {
            width: 10%!important;
            height: 45%!important;
            position: relative!important;
            top: 25%!important;
            left: 3%!important;
        }
        .slds-page-header
        {
            padding: 0.25rem 0.25rem!important;     
        }
        .AM_TopImgContainerImg
        {
            color: #fe8f60;       
        }
        .AM_TopImgContainer
        { 
            position: absolute;
            left: 77%; 
            top: 3%;
        }
        #AM_zoom
        {
            position: relative;
            left: 30%;
        }
        #AM_ServImg
        {
            margin-top: 3%;
            margin-bottom: 3%;
        }   
        .AM_dispNone
        {
            display: none!important;
        }
        .AM_dispNone2
        {
            display: none!important;
        }
        #AM_container 
        {
            margin: 0.5%;    
        }
        #AM_body
        {
            margin-bottom: 0.5%;  
        }
        #cartImg
        {
            background-color: #005fb2;
            border-radius: 4px;  
        }     
        #AM_Filter, #AM_ResetFilter  
        { 
            margin-top: 5%;  
            margin-bottom: 5%;
            margin-right: 2%; 
            margin-left: 4%;  
        }
        #AM_filterList
        {
            margin-left: 1.5%;
            margin-right: 3.5%;   
        }  
        #AM_leftSection
        {
            height: 230px;
        }
        #AM_FilterDiv
        {
            margin-top: 3%;
            margin-bottom: 3%;
            margin-left: 1%;
            margin-right: 1%;
        } 
        #AM_Slide_Filter
        {
            margin-left:2%;
        }
        #AM_owl_containerAll
        {  
            background: #fff; 
            padding: 0% 2.5%;
            -webkit-border-radius: 3%;
            -moz-border-radius: 3%;
            border-radius: 3%; 
        }
        #AM_serviceCarousel
        {  
            background: #fff; 
            padding: 5%; 
            -webkit-border-radius: 3%;
            -moz-border-radius: 3%;
            border-radius: 3%; 
        }
        #AM_configurationSection
        {
            margin-top:1%;
        }
        .AM_owl-item
        {
            background: #fff; 
            padding: 5%;
            margin-right: 5%;
            margin-left: 5%;
            border-radius: 3%;
            -webkit-border-radius: 3%;
            -moz-border-radius: 3%;

            background: #f4f6f9!important; /* For browsers that do not support gradients */
            background: -webkit-linear-gradient(#f4f6f9, white)!important; /* For Safari 5.1 to 6.0 */
            background: -o-linear-gradient(#f4f6f9, white)!important; /* For Opera 11.1 to 12.0 */
            background: -moz-linear-gradient(#f4f6f9, white)!important; /* For Firefox 3.6 to 15 */
            background: linear-gradient(#f4f6f9, white)!important; /* Standard syntax (must be last) */
        }
        .AM_owl-item_Services
        { 
            width: 90%;
            margin-left: 1%;
            margin-right: 1%;
        }
        .AM_productImg
        {
            width: 50%!important;
            height: 50%!important;
            margin-bottom: 5%;
            margin-top: 5%;
            border: 1px solid #d8dde6 !important; 
        }
        .AM_toCartButton
        {
            margin-left: 5%!important;
            margin-bottom: 5%!important;
        }
        #owl-demo .item
        {
            margin: 3px;
        }
        #owl-demo .item img
        {
            display: block;
            width: 100%;
            height: auto;
        }
        .AM_closed
        {
            
            margin-left:-10%;
        } 
        .AM_opened
        {  
            
            margin-left:0%;
        } 
        .AM_H3
        {
            margin-bottom: 5%!important;
        } 
        li#AM_li_1:before 
        {    
            display: none; 
        }
        .AM_LiBorderRound_Left  
        {
            border-top-left-radius: 15em;
            border-bottom-left-radius: 15em;
        }
        .AM_LiBorderRound_Right  
        {
            border-top-right-radius: 15em;
            border-bottom-right-radius: 15em;
        }
        #AM_searchDiv
        {
            width: 85%!important;
            margin-left: 5%;
        } 
        #AM_aggiungi
        {
            margin-top:1%;
        }
        #AM_descr
        {
            margin-top: 10%;
        }
        #AM_ServiceContent
        {
            margin-bottom: 5%;
            margin-top: 5%;        
        }
        #AM_prodInCart
        {
            float: right; 
            margin-left: 15%
        }
        #AM_CartSection
        {
            margin-top: 3%;
            margin-left: 5%;
            margin-right: 5%;
            margin-bottom: 3%;
        } 
        .AM_redButton
        {
            padding-left: 1rem!important;
            padding-right: 1rem!important;;
            text-align: center!important;;
            vertical-align: middle!important;;
            background-color: #fa0505!important;;
            border: 1px solid #fa0505!important;;
            color: white!important;
        }
        .AM_disabled
        {
            padding-left: 1rem!important;  
            padding-right: 1rem!important;  
            text-align: center!important;  
            vertical-align: middle!important;  
            background-color: #d8dde6!important;  
            border: 1px solid #d8dde6!important;
            color: white!important;  
            white-space: nowrap!important; 
        }
        .AM_checkOutTrue
        {
            padding-left: 1rem!important;  
            padding-right: 1rem!important;  
            text-align: center!important;  
            vertical-align: middle!important;  
            background-color: #0db14b!important;  
            border: 1px solid #0db14b!important;
            color: white!important;  
            white-space: nowrap!important; 
        }
        #AM_warnMsg
        { 
            border: 3px solid #fa0505;
            color: #fa0505;
            padding: 4%;
            margin: 2%;
        } 
        .fa-plus
        { 
            margin-left:5%;
        }
        
        .AM_tbody
        {
            height: 250px;
            overflow-y: scroll;
        }
        #AM_qtyAdded
        {
            color:  red;
            float:  right;
        }
        .AM_colorRed
        {
            color: red!important;
        }
        .AM_colorGreen
        {
            color: #0db14b!important;
        }
        #AM_summarySection
        {
            z-index: 50;
            position:absolute; 
            background-color: white; 
            width: 100%!important;
            margin-left:74%;
            margin-right:3%;
            margin-top: -2%;
        }
        .slds-p-around--medium
        {
            padding: 0.5em!important;
            height: : 28%!important;
        } 
        .AM_categItemTabs 
        {
            margin-left: 15%;
            max-height: 200px;
            overflow-y: auto;
        }
        .AM_selected
        {
            background-color: #f0f8ff!important;
        }
        /*.slds-text-title--caps 
        {
            background-color: #f4f6f9!important;
        }*/
        #AM_resetButton, #AM_checkOutButton
        {
            margin-top: 2%;
            margin-right: 2%;
        } 
        .AM_productDetHeader
        {
            margin-top: 1%;
        }
        #AM_cartMsg
        {
            margin:3%;
            padding: 2%;
        }
        #AM_total
        {
            padding:5%;
        }
        .AM_list
        { 
            padding-right: 0%!important;
        }
        .AM_list2
        {
            padding-left: 5%;
            padding-right: 5%;
            padding-top: 4%;
            padding-bottom: 4%;
        } 
        #tab-scoped-1
        {
            height: 400px!important;
        }
        #tab-scoped-2__item
        {
            float: left;
        } 
        .AM_backgroundGrey
        {
            background-color: #f4f6f9; 
    		border-bottom: 1px solid #e4e8ee;
        } 
        #AM_childAttrContent, #AM_attributesContainer
        {  
		    height: 295px;
		    max-height: 295px;
		    overflow-y: auto!important;
		    padding-left: 10%;
		    padding-right: 10%;
		    padding-top: 3%;
		    padding-bottom: 3%;
		    border-left: #ebeff3 2px solid; 
		    margin-left: 3%; 
		    margin-right: 3%; 
        }
        #AM_counter
        {
            margin-left: 8%;
        }
        .fa-exclamation-triangle
        {
            margin-right: 5%!important;
            margin-left: 2%!important;
            margin-top: 3%!important;
        }
        #AM_extChildProduct
        {
            text-transform: uppercase; 
            margin-left: 2%;
        }
        #AM_envelopeMsg_section
        {
            display: block;
            margin-top: -3%;
            margin-right: 11%;
            max-height: 150px;
            overflow-y: auto;
        }
        #AM_envelopeMsg
        {
            margin-left: 10%;
        }
    </style>  
    <script>
        
        /****  global var  ****/  
        var catalogId = '{!catalogId}'; 
        var orderId = '{!ordId}';

        var tabString           = '';     
        var accountType         = '';   
        var productList         = []; //all product
        //******************************************************  LIST FOR SEARCH BAR   *******************************************************\\
        var productListName     = [];  
        var productGasRes       = [];
        var productGasBus       = [];
        var productEleRes       = [];
        var productEleBus       = [];
        var productServPart     = [];
        var productKitCarrello  = []; 
        var productKitPreconf   = [];
        
        var productResidenziale = [];
        var productBusiness     = [];
        var productKitLed       = [];
        
        var mappa               = {}; 
        //**************************************************************************************************************************************\\
        var allCarouselItems    = '';
        var category            = '';
        var categoryName        = ''; 
        var mapForEligibility   = {};
        //**************************************************** path string for img resource ****************************************************\\
      
        var path            =   '';
        var CARTimgPath     =   "{!URLFOR($Resource.NELightningResource,            '/assets/icons/custom/custom93_60.png')}"; 
        var GASimgPath      =   "{!URLFOR($Resource.ITA_IFM_AppMobile_images,       '/MT_img/gas.png')}";
        var LUCEimgPath     =   "{!URLFOR($Resource.ITA_IFM_AppMobile_images,       '/MT_img/luce.png')}";
        var SERVIZIimgPath  =   "{!URLFOR($Resource.ITA_IFM_AppMobile_images,       '/MT_img/service.png')}";
        var KITimgPath      =   "{!URLFOR($Resource.ITA_IFM_AppMobile_images,       '/MT_img/led.png')}";  
        var KEYimgPath      =   "{!URLFOR($Resource.NELightningResource,            '/assets/icons/utility/custom_apps_60.png')}";
        var PLUSimgPath     =   "{!URLFOR($Resource.NELightningResource,            '/assets/icons/utility/add_60.png')}"; 
        var enelIcon        =   "{!URLFOR($Resource.ITA_IFM_AppMobile_images,       '/MT_img/Enel_icons_all.png')}";
        //**************************************************************************************************************************************\\
        //**************************************************************************************************************************************\\ 
        var mapOfCategories   = {};  
        var catalogAttachment = {};
        //**************************************************************************************************************************************\\
         
        $(window).ready(function(){ 
            getAllProd(); 
        });
        //**************************************************************************************************************************************\\
         
        function reLoadPage()
        {
            console.log('tabstring');
            console.log(tabString);
            categoryName = ''; 
            category = '';
            accountType = ''; 
            $("#AM_li_1").addClass("slds-hidden slds-is-current").removeClass("slds-is-complete");            
            $("#AM_li_2").addClass("slds-hidden");
            $('.AM_categToAppend1').empty();
            $('.AM_categToAppend2').empty();
            $("#AM_filterList").empty(); 
            $("#AM_FilterDiv").removeClass("slds-hide");
            $("#AM_rightTab").removeClass("AM_dispNone");
            $("#AM_Tab").empty();
            $("#AM_Tab").append(tabString); 
            $("#AM_CartSection").addClass("slds-hide");
            $("#AM_body").removeClass("slds-hide");  
            //inside the cart
            $("#AM_leftNavBar").empty(); ;
            $("#AM_categoryTabs").empty(); 
            $("#AM_attributesDiv").empty();
				
            for(var i = 0; i<productList.length;i++) 
            {  
                var idP = productList[i].NE__ProductId__c;
                $('#AM_ProductName_'+idP).removeClass('AM_dispNone AM_dispNone2');    

                if( orderId == '' || orderId == null)
                {
                   alert('manca id ordine'); 
                }
                else
                {
                    Visualforce.remoting.Manager.invokeAction
                    { 
                        '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.getAllProduct}',     
                        orderId,            
                        function(result, event) 
                        {}
                    } 
                }                   
            } 

            if( !$('#AM_productDetail').hasClass('AM_dispNone') ) 
            {
            	backToProduct();
            }

        }
        //**************************************************************************************************************************************\\
        
        //**************************************************************************************************************************************\\
         
        var carouselItemList = [];
        function getAllProd()
        {
            console.log('**** getAllProd ***');
            startLoading();
            var path = ''; 
            tabString = $("#AM_Tab").html(); 
            var owl = $('#AM_owl_containerAll');
            owl.owlCarousel
            (
                {  
                  items                     :   4, 
                  itemsCustom               :   [1024,4],
                  pagination                :   false, 
                  paginationNumbers         :   false,  
                  slideSpeed                :   300,
                  paginationSpeed           :   400,   
                  navigation                :   true,  
                  paginationItems           :   3, 
                  rewindNav                 :   false                                    
                }
            );  
            
            $(".owl-prev").empty().append('<i class="fa fa-chevron-left"></i>');

            if( orderId == '' || orderId == null )
            {
                console.log('+++');
            } 
            else  
            {
                console.log('**** order id: '+orderId);  
                Visualforce.remoting.Manager.invokeAction
                ( 
                    '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.getAllProduct}',    
                    orderId,             
                    function(result, event)
                    {  
                        console.log('result size: '+result.length );
                        console.log(result);
                        if(result.length != 0 || result.length != null)
                        {
                            for(var i = 0; i < result.length; i++)
                            {   
                                productListName[i] = result[i].NE__ProductId__r.Name;   
                                mappa["All"] = productListName;
                                category = result[i].NE__Catalog_Category_Name__r.Name;     
                                var checkVetrina = result[i].ITA_IFM_AM_Vetrina__c;                      
                                if( category!= '' || category!= null )
                                {
                                    //console.log('category: '+category);
                                    if( category.includes("Gas") )
                                    {
                                        //console.log('*** GAS ***'); 
                                        path = GASimgPath;
                                        imgClass = 'AM_gasIcon';
                                        if( category.indexOf("Residenziale")>0 )
                                        { 
                                            //console.log('*** GAS - RESIDENZIALE ***');
                                            productGasRes.push(result[i].NE__ProductId__r.Name);    
                                            productResidenziale.push(result[i].NE__ProductId__r.Name);
                                            mappa[category] = productGasRes;
                                        }
                                        else if( category.indexOf("Business")>0 )
                                        {
                                            //console.log('*** GAS - BUSINESS ***');
                                            productGasBus.push( result[i].NE__ProductId__r.Name);
                                            productBusiness.push(result[i].NE__ProductId__r.Name); 
                                            mappa[category] = productGasBus;
                                        }
                                    }
                                    else if( category.includes("Elettrico") )  
                                    {
                                        //console.log('*** ELETTRICO ***');
                                        path = LUCEimgPath; 
                                        imgClass = 'AM_eleIcon';
                                        if( category.indexOf("Residenziale")>0 )
                                        {
                                            productEleRes.push(result[i].NE__ProductId__r.Name);
                                            productResidenziale.push(result[i].NE__ProductId__r.Name);   
                                            mappa[category] = productEleRes; 
                                        }
                                        else if( category.indexOf("Business")>0 )
                                        {
                                            productEleBus.push( result[i].NE__ProductId__r.Name);
                                            productBusiness.push(result[i].NE__ProductId__r.Name); 
                                            mappa[category] = productEleBus;  
                                        } 
                                    } 
                                    else if( category.includes("Servizi") )
                                    {
                                         path = SERVIZIimgPath;
                                         imgClass = 'AM_serviceIcon';
                                         productServPart.push(result[i].NE__ProductId__r.Name); 
                                         mappa[category] = productServPart; 
                                    } 
                                    else if( category.includes("Beni") )
                                    {
                                         path = KITimgPath;
                                         imgClass = 'AM_kitIcon';
                                         if( category.indexOf("carrello")>0 )
                                         {
                                            productKitCarrello.push(result[i].NE__ProductId__r.Name);  
                                            productKitLed.push(result[i].NE__ProductId__r.Name);     
                                            mappa[category] = productKitCarrello; 
                                         }
                                         else if( category.indexOf("Preconfigurati")>0 )
                                         {  
                                            productKitPreconf.push(result[i].NE__ProductId__r.Name); 
                                            productKitLed.push(result[i].NE__ProductId__r.Name); 
                                            mappa[category] = productKitPreconf;       
                                         }
                                         
                                    }
                                    mappa["Residenziale"] = productResidenziale;  
                                    mappa["Business"] = productBusiness; 
                                    mappa["Kit LED"] = productKitLed;
                                }
     
                                if( checkVetrina == true )  
                                {
                                    console.log('############ prodotti vetrina ############# ');
                                    allCarouselItems = allCarouselItems + '<div id="AM_ProductName_'+result[i].NE__ProductId__c+'" class="item slds-card slds-text-align--center AM_owl-item ">';    
                                    allCarouselItems = allCarouselItems + '<img id="AM_ProductImg_'+result[i].Id+'" class="AM_productImg slds-icon slds-icon--large slds-icon_container" src="'+path+'"/>'; 
                                    allCarouselItems = allCarouselItems + '<div class="AM_TopImgContainer"><i class="fa fa-star fa-3x AM_TopImgContainerImg" ></i></div>';
                                    allCarouselItems = allCarouselItems + '<h3 id="AM_prodTitle_'+result[i].Id+'" class="slds-truncate AM_H3">'+result[i].NE__ProductId__r.Name+'</h3>'; 
                                    allCarouselItems = allCarouselItems + '<div class="slds-grid AM_color">';   
                                    allCarouselItems = allCarouselItems + '<div><button id="AM_info_'+result[i].Id+'" class="slds-button" onClick="productDetail(this.id)" data-catalogId="'+result[i].NE__Catalog_Id__c+'" data-categoryId="'+result[i].NE__Catalog_Category_Name__c+'" data-commodity="'+result[i].NE__ProductId__r.ITA_IFM_Commodity__c+'" data-itemheader="'+result[i].NE__Item_Header__c+'" data-rootid="'+result[i].NE__Root_Catalog_Item__c+'" data-baseonetimefee="'+result[i].NE__Base_OneTime_Fee__c+'" data-baserecurringcharge="'+result[i].NE__BaseRecurringCharge__c+'" data-recurringchargefrequency="'+result[i].NE__Recurring_Charge_Frequency__c+'" data-productname="'+result[i].NE__ProductId__r.Name+'" data-productid="'+result[i].NE__ProductId__c+'" data-productenginecode="'+result[i].NE__ProductId__r.NE__Engine_Code__c+'" data-enginecode="'+result[i].NE__Engine_Code__c+'" data-deliverytype="'+result[i].ITA_IFM_Delivery_Type__c+'" data-configurationtype="'+result[i].NE__Configuration_Type__c+'">'; 
                                    allCarouselItems = allCarouselItems + '<span class="slds-text-not-selected slds-text-heading--small">{!$Label.ITA_IFM_AM_Info}';  
                                    allCarouselItems = allCarouselItems + '<i class="fa fa-search-plus slds-icon slds-icon--small"></i>';
                                    allCarouselItems = allCarouselItems + '</span></button></div>'; 
                                    allCarouselItems = allCarouselItems + '<div class="slds-col--bump-left">';
                                    allCarouselItems = allCarouselItems + '<button id="'+result[i].Id+'" class="slds-button" onClick="retrieveProd(this.id)" data-catalogId="'+result[i].NE__Catalog_Id__c+'" data-categoryId="'+result[i].NE__Catalog_Category_Name__c+'" data-commodity="'+result[i].NE__ProductId__r.ITA_IFM_Commodity__c+'" data-itemheader="'+result[i].NE__Item_Header__c+'" data-rootid="'+result[i].NE__Root_Catalog_Item__c+'" data-baseonetimefee="'+result[i].NE__Base_OneTime_Fee__c+'" data-baserecurringcharge="'+result[i].NE__BaseRecurringCharge__c+'" data-recurringchargefrequency="'+result[i].NE__Recurring_Charge_Frequency__c+'" data-productname="'+result[i].NE__ProductId__r.Name+'" data-productid="'+result[i].NE__ProductId__c+'" data-productenginecode="'+result[i].NE__ProductId__r.NE__Engine_Code__c+'" data-enginecode="'+result[i].NE__Engine_Code__c+'" data-deliverytype="'+result[i].ITA_IFM_Delivery_Type__c+'" data-configurationtype="'+result[i].NE__Configuration_Type__c+'" data-producttypology="'+result[i].NE__ProductId__r.ITA_IFM_Product_Typology__c+'">';
                                    allCarouselItems = allCarouselItems + '<span class="slds-text-not-selected slds-text-heading--small">{!$Label.ITA_IFM_AM_Aggiungi}';  
                                    allCarouselItems = allCarouselItems + '<i class="fa fa-shopping-cart slds-icon slds-icon--small"></i>';
                                    allCarouselItems = allCarouselItems + '</span></button></div></div></div>';
                                    carouselItemList.push(allCarouselItems);
                                    allCarouselItems = ''; 
                                } 
                                else
                                {
                                    allCarouselItems = allCarouselItems + '<div id="AM_ProductName_'+result[i].NE__ProductId__c+'" class="item slds-card slds-text-align--center AM_owl-item ">';   
                                    allCarouselItems = allCarouselItems + '<img id="AM_ProductImg_'+result[i].Id+'" class="AM_productImg slds-icon slds-icon--large slds-icon_container" src="'+path+'"/>'; 
                                    allCarouselItems = allCarouselItems + '<h3 id="AM_prodTitle_'+result[i].Id+'" class="slds-truncate AM_H3" title="Anypoint Connectors">'+result[i].NE__ProductId__r.Name+'</h3>';  
                                    allCarouselItems = allCarouselItems + '<div class="slds-grid AM_color">';
                                     allCarouselItems = allCarouselItems + '<div><button id="AM_info_'+result[i].Id+'" class="slds-button" onClick="productDetail(this.id)" data-catalogId="'+result[i].NE__Catalog_Id__c+'" data-categoryId="'+result[i].NE__Catalog_Category_Name__c+'" data-commodity="'+result[i].NE__ProductId__r.ITA_IFM_Commodity__c+'" data-itemheader="'+result[i].NE__Item_Header__c+'" data-rootid="'+result[i].NE__Root_Catalog_Item__c+'" data-baseonetimefee="'+result[i].NE__Base_OneTime_Fee__c+'" data-baserecurringcharge="'+result[i].NE__BaseRecurringCharge__c+'" data-recurringchargefrequency="'+result[i].NE__Recurring_Charge_Frequency__c+'" data-productname="'+result[i].NE__ProductId__r.Name+'" data-productid="'+result[i].NE__ProductId__c+'" data-productenginecode="'+result[i].NE__ProductId__r.NE__Engine_Code__c+'" data-enginecode="'+result[i].NE__Engine_Code__c+'" data-deliverytype="'+result[i].ITA_IFM_Delivery_Type__c+'" data-configurationtype="'+result[i].NE__Configuration_Type__c+'">'; 
                                    allCarouselItems = allCarouselItems + '<span class="slds-text-not-selected slds-text-heading--small">{!$Label.ITA_IFM_AM_Info}';  
                                    allCarouselItems = allCarouselItems + '<i class="fa fa-search-plus slds-icon slds-icon--small"></i>';
                                    allCarouselItems = allCarouselItems + '</span></button></div>'; 
                                    allCarouselItems = allCarouselItems + '<div class="slds-col--bump-left">'; 
                                    allCarouselItems = allCarouselItems + '<button id="'+result[i].Id+'" class="slds-button" onClick="retrieveProd(this.id)" data-catalogId="'+result[i].NE__Catalog_Id__c+'" data-categoryId="'+result[i].NE__Catalog_Category_Name__c+'" data-commodity="'+result[i].NE__ProductId__r.ITA_IFM_Commodity__c+'" data-itemheader="'+result[i].NE__Item_Header__c+'" data-rootid="'+result[i].NE__Root_Catalog_Item__c+' "data-baseonetimefee="'+result[i].NE__Base_OneTime_Fee__c+'" data-baserecurringcharge="'+result[i].NE__BaseRecurringCharge__c+'" data-recurringchargefrequency="'+result[i].NE__Recurring_Charge_Frequency__c+'" data-productname="'+result[i].NE__ProductId__r.Name+'" data-productid="'+result[i].NE__ProductId__c+'" data-productenginecode="'+result[i].NE__ProductId__r.NE__Engine_Code__c+'" data-enginecode="'+result[i].NE__Engine_Code__c+'" data-deliverytype="'+result[i].ITA_IFM_Delivery_Type__c+'" data-configurationtype="'+result[i].NE__Configuration_Type__c+'"  data-producttypology="'+result[i].NE__ProductId__r.ITA_IFM_Product_Typology__c+'">';
                                    allCarouselItems = allCarouselItems + '<span class="slds-text-not-selected slds-text-heading--small">{!$Label.ITA_IFM_AM_Aggiungi}'; 
                                    //allCarouselItems = allCarouselItems + '<img class="slds-icon slds-icon--small" src="'+CARTimgPath+'"/>';
                                    allCarouselItems = allCarouselItems + '<i class="fa fa-shopping-cart slds-icon slds-icon--small"></i>';
                                    allCarouselItems = allCarouselItems + '</span></button></div></div></div>';
                                    carouselItemList.push(allCarouselItems);
                                    allCarouselItems = '';
                                }                             
                            }
                        
                        }  
                        productList = result;
                        owl.data('owlCarousel').addItem(carouselItemList);  
                        $(".owl-prev").empty().append('<i class="fa fa-chevron-left"></i>');
                        $(".owl-next").empty().append('<i class="fa fa-chevron-right"></i>');
                        openFilter();   
                        endLoading(); 
                    }         
                ); 
            } 
        } 

        function AM_TopImgContainertCarousel()
        {
            console.log('** AM_TopImgContainert carousel ***');  
            $('#AM_owl_containerAll').owlCarousel
            (
                {  
                  items                     :   3, 
                  itemsCustom               :   [1024,3],
                  pagination                :   false, 
                  paginationNumbers         :   false,  
                  slideSpeed                :   300,
                  paginationSpeed           :   400,   
                  navigation                :   true, 
                  paginationItems           :   3, 
                  rewindNav                 :   false                                    
                }
            );
        }  

        function openCategory(currentCategory)
        { 
            var catId = currentCategory.substring(7,currentCategory.length); 
            console.log(''+currentCategory);
            if( $('#'+currentCategory).children('.fa').hasClass('fa-chevron-right') )
            {  
                $('#'+currentCategory).children('.fa').removeClass('fa-chevron-right').addClass('fa-chevron-down');
                $('#AM_categName_'+catId).children('.AM_categItemTabs').removeClass('slds-hide');
                $('#AM_categName_'+catId).addClass('AM_selected'); 
                
                var currentLi = $('#AM_categName_'+catId); 									//current tag <li>
                var currentUl = $('#AM_categName_'+catId).children('.AM_categItemTabs'); 	//current tag <ul>
                var currentChevron = $('#'+currentCategory).children('.fa');  				//current tag <i>
                $('.AM_list').not(currentLi).removeClass('AM_selected');
                $('.AM_categItemTabs').not(currentUl).addClass('slds-hide');
                $('.AM_chevron').not(currentChevron).removeClass('fa-chevron-down').addClass('fa-chevron-right'); 
            }
            else if( $('#'+currentCategory).children('.fa').hasClass('fa-chevron-down') )
            { ;
                $('#'+currentCategory).children('.fa').addClass('fa-chevron-right').removeClass('fa-chevron-down');
                $('#AM_categName_'+catId).children('.AM_categItemTabs').addClass('slds-hide');
                $('#AM_categName_'+catId).removeClass('AM_selected');
            } 
        }            

        function openCartSection(productName, childItemListSize)
        {
            console.log('OPEN CART SECTION OF CATALOG ITEM-->'); 
            $("#AM_summarySection").addClass("AM_dispNone");
            $("#AM_attributesContainerTitle").append('<div id="AM_attributesContainerTitle" class="slds-text-heading--medium">Now Configuring '+productName+'</div>');
            $("#AM_FilterDiv").addClass("slds-hide");
            $("#AM_body").addClass("slds-hide");
            $("#AM_CartSection").removeClass("slds-hide");
            
            console.log('###testo '+$("#AM_prodSummary").text());
            $("#AM_prodSummary").empty();
            $("#AM_prodSummary").text('SUMMARY  ('+childItemListSize+')');
            $("#AM_extProduct").append();
        } 

        function openFilter()
        {           
            if( $('#AM_rightSection').hasClass("slds-medium-size--6-of-6 slds-large-size--12-of-12") )
            { 
                $('#AM_rightSection').removeClass("slds-medium-size--6-of-6 slds-large-size--12-of-12").addClass("slds-medium-size--4-of-6 slds-large-size--9-of-12").animate( "slow" );
                $('#AM_leftSection').slideToggle(600); 
                 
            }
            else if( $('#AM_rightSection').hasClass("slds-medium-size--4-of-6 slds-large-size--9-of-12") )
            { 
                $('#AM_rightSection').removeClass("slds-medium-size--4-of-6 slds-large-size--9-of-12").addClass("slds-medium-size--6-of-6 slds-large-size--12-of-12").animate( "slow" );
                $('#AM_leftSection').slideToggle(600);  
            } 
        }
        
           
        
        function resetFilter()
        {
            console.log('*** reset filtro ***'); 
            $(".AM_select").prop('selectedIndex',0);
            $('#AM_searchBar').val("");
            searchProduct();
        }
           
        function searchProduct()
        {
            var valueToSearch = $('#AM_searchBar').val();
            
            console.log('categoryName: '+categoryName);
            console.log('accountType: '+accountType);

            if ( valueToSearch == null || valueToSearch == '')         
            { 
                if( (categoryName != null || categoryName != '') && (accountType == null || accountType == '') )
                {
                    console.log('*** nullo ***');
                    $( '.AM_owl-item' ).removeClass("AM_dispNone");
                }
                else if( categoryName == '' )
                {
                    console.log('category name nullo - accounttype non nullo');
                    
                    for(var x= 0; x<productList.length; x++) 
                    {
                        var idP             = productList[x].NE__ProductId__c;
                        var prodCategory    = productList[x].NE__Catalog_Category_Name__r.Name;  
                        if( prodCategory.indexOf(accountType)>0 )
                        {
                             console.log('okk2');                
                             $("#AM_ProductName_"+idP).removeClass("AM_dispNone");
                        } 
                    }  
                } 
                else if( categoryName != '' ) 
                { 
                    console.log('cancella solo i prodotti relativi a questa categoria');   
                    console.log(categoryName); 
                    for(var x= 0; x<productList.length; x++) 
                    {  
                        var idP             = productList[x].NE__ProductId__c;
                        var prodCategory    = productList[x].NE__Catalog_Category_Name__r.Name; 
                        if(categoryName == prodCategory)
                        {
                             console.log('okk1');                
                             $("#AM_ProductName_"+idP).removeClass("AM_dispNone");
                        } 
                    }    
                } 
                var owl = $('#AM_owl_containerAll').data('owlCarousel');
                owl.goTo(0);      
            }
//********************************************************************************************************// 
            else
            {
                console.log("***valueToSearch: "+valueToSearch);
                if( (categoryName == null || categoryName == '') && (accountType == null ||accountType == '') ) 
                {   
                    console.log('###accountType nullo###category nunlla###');
                    $("#AM_searchBar").autocomplete(
                    {
                        source : mappa["All"],
                        select: function (event, ui) 
                        {
                            AutoCompleteSelectHandler(event, ui)
                        }
                    }); 
                }
                else if( (categoryName == null || categoryName == '') && (accountType != null || accountType != '') ) 
                {  
                    console.log('###accountType###'+accountType); 
                    $("#AM_searchBar").autocomplete(
                    {
                        source : mappa[accountType],
                        select: function (event, ui) 
                        {
                            AutoCompleteSelectHandler(event, ui)
                        }
                    }); 
                }
                else if( categoryName != null || categoryName != '' )
                {
                    console.log('###accountType###  '+accountType); 
                    console.log('###categoryName### '+categoryName); 
                    $("#AM_searchBar").autocomplete(
                    {
                        source : mappa[categoryName],
                        select: function (event, ui) 
                        {
                            AutoCompleteSelectHandler(event, ui)
                        }
                    }); 
                }
            }
        }
             
        function AutoCompleteSelectHandler(event, ui)
        {               
            var selectedProd = ui.item.label;     
            console.log('*** selectedProd: '+selectedProd); 
            console.log('productList size '+productList.length);
            if( categoryName == '' || categoryName == null ) 
            {  
                for(var i = 0; i<productList.length; i++)
                {
                    var prodName    = productList[i].NE__ProductId__r.Name;
                    var prodId      = productList[i].NE__ProductId__r.Id; 
                    if( prodName == selectedProd )       
                    {
                        $("#AM_ProductName_"+prodId).removeClass("AM_dispNone"); 
                    }
                    else 
                    { 
                        $("#AM_ProductName_"+prodId).addClass("AM_dispNone"); 
                    }
                } 
            }
            else 
            { 
                for(var i = 0; i<productList.length; i++)
                {
                    var prodName        = productList[i].NE__ProductId__r.Name;
                    var prodId          = productList[i].NE__ProductId__r.Id; 
                    var categoryProd    = productList[i].NE__Catalog_Category_Name__r.Name;
                    console.log(prodName == selectedProd && categoryProd == categoryName)
                    if( prodName == selectedProd && categoryProd == categoryName )       
                    {
                        console.log('*** ok ***');
                        $("#AM_ProductName_"+prodId).removeClass("AM_dispNone");
                    }
                    else if( prodName != selectedProd && categoryProd == categoryName ) 
                    {
                        $("#AM_ProductName_"+prodId).addClass("AM_dispNone");
                    }  
                }
            }
            var owl = $('#AM_owl_containerAll').data('owlCarousel');
            owl.goTo(0);  
        } 

        
        function goBack()
        {  
            if( $("#AM_li_1").hasClass("slds-is-complete") )
            {  
                console.log(accountType);
                categoryName = '';  
                $("#AM_li_2").addClass("slds-hidden");
                $('.AM_categToAppend2').empty();
                $("#AM_li_1").removeClass("slds-is-complete").addClass("slds-is-current").addClass("AM_LiBorderRound_Right");  
                $("#AM_filterList").empty();
                $("#AM_rightTab").removeClass("AM_dispNone");
                
                for(var i = 0; i<productList.length;i++) 
                {  
                    var catalogCategory = productList[i].NE__Catalog_Category_Name__r.Name; 
                    var prodName = productList[i].NE__ProductId__r.Name;
                    var idP = productList[i].NE__ProductId__c;
                    if( catalogCategory.indexOf( accountType ) == -1 )
                    {
                        $('#AM_ProductName_'+idP).addClass('AM_dispNone'); 
                    }
                    else 
                    {
                        $('#AM_ProductName_'+idP).removeClass('AM_dispNone'); 
                    }                 
                } 
            }       
        }
        
        function getCategories(clicked_id)
        {
            //console.log('HAI CLICCATO '+clicked_id);  
            var categoryVal = $("#"+clicked_id).text();         
              
            $("#AM_li_1").removeClass("slds-hidden").addClass("AM_LiBorderRound_Right");    
            $(".AM_categToAppend1").append(categoryVal);                
            $("#AM_Tab").empty();
            
            if(clicked_id == 'home')
            {
                accountType = 'Residenziale';
            }
            else if(clicked_id == 'business')
            {
                accountType = 'Business';
            }
            else if(clicked_id == 'serviziPartner')
            {
                //accountType = 'Servizi Partner';
                accountType = 'Servizi';
            }
            else if(clicked_id == 'kitLed')
            {
                //accountType = 'Kit LED';
                accountType = 'Beni';
            }
            
            console.log('*** cliccato get categories search bar: '+$('#AM_searchBar').val()); 
            if( $('#AM_searchBar').val() != null && $('#AM_searchBar').val() != '')
            {
                console.log('search bar piena');
                $('#AM_searchBar').val('');
            }     
            
            console.log('**** category primo step :'+accountType);
            for(var i = 0; i<productList.length;i++) 
            {  
                var catalogCategory = productList[i].NE__Catalog_Category_Name__r.Name; 
                console.log('*** catalogCategory: '+catalogCategory)
                var prodName = productList[i].NE__ProductId__r.Name;
                var idP = productList[i].NE__ProductId__c;
                if( catalogCategory.indexOf( accountType ) == -1 )
                {
                    $('#AM_ProductName_'+idP).addClass('AM_dispNone'); 
                    //owl.removeItem(i); 
                }                 
            }   
             
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.getCategories}',
                accountType,
                function(result, event)
                {                      
                     for(var i = 0; i < result.length; i++)
                     {
                        $("#AM_Tab").append('<tr><th scope="row" data-label="Opportunity Name"><div class="slds-truncate"><a id="'+result[i].Name+'" href="javascript:void(0);" onclick="showCategory(this.id)">'+result[i].Name+'</a></div></tr></th>');       
                     }
                }
            );
        }
        
        function showCategory(category)
        {
            console.log('*** showCategory *** --->' +category); 
            categoryName = category;
           
            $("#AM_li_1").removeClass("slds-is-current AM_LiBorderRound_Right").addClass("slds-is-complete");  
            $("#AM_li_2").removeClass("slds-hidden");
            $("#AM_li_2").addClass("slds-is-current AM_LiBorderRound_Right");  
            $(".AM_categToAppend2").append(category); 
            $("#AM_rightTab").addClass("AM_dispNone");  
            getFilterOnCatalogCategory(category);       
            getSelectFilter(category)
             
        }  
        
        function getFilterOnCatalogCategory(category)              
        {
            //console.log('*** getFilterOnCatalogCategory *** --->' +category);   
            var tempItems = [];
            var divRemoved = '';  
            var owl = $("#AM_owl_container");
            for(var i = 0; i<productList.length;i++)
            { 
                var prodId = 'AM_ProductName_'+productList[i].NE__ProductId__c;
                var catalogCategory = productList[i].NE__Catalog_Category_Name__r.Name;
                var idP = productList[i].NE__ProductId__c;
                if( catalogCategory != category )
                {
                    //console.log('*** NON trovato in ***   '+productList[i].NE__ProductId__r.Name);
                    $('#AM_ProductName_'+idP).addClass('AM_dispNone');
                }                 
            }    
        }
         
        function getSelectFilter(category)
        {
            console.log('***getSelectFilter*** --->'+category);
            $('#AM_filterList').removeClass('AM_dispNone');             
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.getFamilies}',
                category,
                function(result, event)
                {  
                    var n = 0;
                    for (var key in result) 
                    {                        
                        $('#AM_filterList').append('<label class="slds-form-element__label" for="select-01">'+key+'</label><div class="slds-form-element__control"><div class="slds-select_container"><select id="AM_select-'+n+'" class="slds-select AM_select" data-select ="'+key+'" onchange ="getOptionValue('+n+')"></select></div></div>');
                        var listOFvalue = result[key]; 
                        if( listOFvalue.length != 0)
                        {
                            $('#AM_select-'+n).append('<option value="-----------">-----------</option>');
                            for(var i = 0; i < listOFvalue.length; i++)
                            {    
                                $('#AM_select-'+n).append('<option>'+listOFvalue[i]+'</option>');
                            }  
                            n++;  
                        }
                    }
                                   
                }               
            );            
        } 
        
        function getOptionValue(n)
        {    
             var label = $('#AM_select-'+n).attr("data-select");   
             var valueOption =  $('#AM_select-'+n).val();           
             var eligibility = label +' - '+valueOption;             
             mapForEligibility['#AM_select-'+n] = eligibility;
             productWithFilter(mapForEligibility);
        }
             
        function productWithFilter(mapForEligibility)
        {    
            console.log('mapForEligibility');
            console.log(mapForEligibility);
            for(var key in mapForEligibility)
            {
                var str = mapForEligibility[key]; 
                console.log('VALORE: '+str);  
                for(var i = 0; i<productList.length;i++)
                {
                    var eligibilityString = productList[i].NE__ProductId__r.ITA_IFM_Eligibility__c;
                    var prodId = 'AM_ProductName_'+productList[i].NE__ProductId__c;
                    
                    if( !(typeof eligibilityString === "undefined") )
                    {
                       
                        if( (eligibilityString.indexOf(str) == -1) && (str.indexOf('-----------') == -1) )
                        {
                            $('#'+prodId).addClass('AM_dispNone2'); 
                        }  
                        else if( eligibilityString.indexOf(str) == -1 && (str.indexOf('-----------')) >0  )
                        { 
                            console.log(eligibilityString.indexOf(str) == -1 && (str.indexOf('-----------')) >0 ); 
                            if( $('#'+prodId).hasClass('AM_dispNone2') )
                            {
                                $('#'+prodId).removeClass('AM_dispNone2');
                            }
                            else if( $('#'+prodId).hasClass('AM_dispNone') ) 
                            {
                                console.log('deve rimanere nascosto');
                            }  
                        } 
                        else if( eligibilityString.indexOf(str)>0)
                        { 
                            if( $('#'+prodId).hasClass('AM_dispNone2') )
                            {
                                $('#'+prodId).removeClass('AM_dispNone2');
                            }
                            else if( $('#'+prodId).hasClass('AM_dispNone') )
                            {
                                console.log('deve rimanere nascosto');
                            }  
                        }
                    }           
                } 
            } 
        } 
        
        
        //*************************************************************  DETAIL PRODUCT SECTION  *********************************************************\\
        var prodServiceCarousel = '';
        var servicesItemList = [];
        
        //initialize services-carousel
        //************************************ GLOBAL VARIABLE FOR PRODUCT ****************************************************\\
        var nameOfCurrentProd = '';
        var imgOfCurrentProd  = '';
        //*****************************************************************************************************************\\
        function productDetail(selectedProductId)
        {
            console.log('click on product img--- id product: '+selectedProductId);  
            var catalogItemId = selectedProductId.substring(8,selectedProductId.length);

            var iconProd = $('#AM_iconProd_'+catalogItemId).attr('class');
            console.log('**** iconProd '+iconProd);
            console.log('catalogItemId: '+catalogItemId);
            var imgSrc = $("#"+selectedProductId).attr('src');
            
            //********************************************  initialize the services carousel **************************************//
            var servicesOwl = $('#AM_serviceCarousel');
            servicesOwl.owlCarousel
            (
                {  
                  items                     :   3, 
                  itemsCustom               :   [1024,3],
                  pagination                :   true, 
                  paginationNumbers         :   false,  
                  slideSpeed                :   300,
                  paginationSpeed           :   400,   
                  navigation                :   false, 
                  paginationItems           :   3,
                  refresh                   :   true,
                  dots                      :   true,
                  rewindNav                 :   false                      
                }
            ); 
            //*********************************************************************************************************************//
            $("#AM_ProdName").empty();
            $("#AM_ProdImg").empty();
            $("#AM_offerta").empty();
            $("#AM_documentToAppend").empty();
            //$("#AM_header").addClass("AM_dispNone");
            $("#AM_body").addClass('AM_dispNone');  
            $("#AM_FilterDiv").addClass('AM_dispNone');  
            $("#AM_productDetail").removeClass('AM_dispNone');  
            
           
            for(var x = 0; x<productList.length; x++)
            {
                if( catalogItemId == productList[x].Id )
                {
                    console.log('***ok***'+productList[x].NE__ProductId__r.Name);
                    imgOfCurrentProd = '<img class="AM_thumbnail slds-icon slds-icon--large slds-icon_container" src="'+imgSrc +'"/>'; 
                    //imgOfCurrentProd = '<div class="AM_thumbnail '+AM+'"></div>';
                    $("#AM_ProdImg").append('');
                    $("#AM_ProdName").append('<h2 id="AM_ProdName_'+productList[x].Id+'" class="slds-text-heading--medium">PRODOTTO</h2><p class="slds-text-heading--medium" title="Product Name">'+productList[x].NE__ProductId__r.Name+'</p>');    
                    showDetail(catalogItemId);
                }  
            }
            
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.getServices}',
                catalogItemId,
                function(result, event)
                {
                    console.log('*** get services *** result ***');
                    console.log(result);
                    if(result.length != 0 && result != null)
                    {
                        for(var i = 0; i<result.length; i++)
                        {
                            prodServiceCarousel += '<div id="AM_ProductName_'+result[i].NE__ProductId__c+'" class="item slds-card slds-text-align--center AM_owl-item AM_owl-item_Services">';  
                            prodServiceCarousel += '<div id="AM_ServiceContent"><i id="AM_ServImg" class="fa fa-file-text-o fa-4x" ></i>';
                            prodServiceCarousel += '<h3 class="slds-truncate AM_H3" title="'+result[i].NE__ProductId__r.Name+'">';
                            prodServiceCarousel += '<p class="slds-text-align--center slds-text-heading--small">'+result[i].NE__ProductId__r.Name;
                            prodServiceCarousel += '</p></h3></div></div>'; 
                            servicesItemList.push(prodServiceCarousel);
                            prodServiceCarousel = '';
                        }
                    } 
                    console.log('#### servicesItemList size= '+servicesItemList.length); 
                    console.log(servicesItemList); 
                    servicesOwl.data('owlCarousel').addItem(servicesItemList); 
                    
                }  
            ) 
        }
        function openModal()
        {
            console.log('@@@@@  APRE LA MODALE @@@@@'); 
            $('.slds-modal').removeClass('AM_dispNone').addClass('slds-fade-in-open');
            $('.slds-backdrop').removeClass('AM_dispNone');
        }
        
        function closeModal()
        {
            console.log('@@@@@  CHIUDE LA MODALE @@@@@'); 
            $('.slds-modal').addClass('AM_dispNone').removeClass('slds-fade-in-open');
            $('.slds-backdrop').addClass('AM_dispNone');
        }
        function changeTab(tabId)  
        {  
            $('#AM_Services, #AM_Details').removeClass("slds-active");  
            $('#AM_Services_div, #AM_Details_div').addClass("slds-hide").removeClass("slds-show"); 
            $("#"+tabId).addClass("slds-active");  
            $("#"+tabId+"_div").removeClass("slds-hide").addClass("slds-show");   
        }
        
        function changeTab_Cart(tabId)  
        {  
            $('#AM_Cart_detail, #AM_Cart_category').removeClass("slds-active");  
            $('#AM_Cart_detail_div, #AM_Cart_category_div').addClass("slds-hide").removeClass("slds-show"); 
            $("#"+tabId).addClass("slds-active");  
            $("#"+tabId+"_div").removeClass("slds-hide").addClass("slds-show");   
        }
        
        function backToProduct()
        {
            $("#AM_body").removeClass('AM_dispNone');  
            $("#AM_FilterDiv").removeClass('AM_dispNone');  
            $("#AM_productDetail").addClass('AM_dispNone'); 
            $("#AM_header").removeClass("AM_dispNone");
            //****************************** reinit carousel ***********************************//
            servicesItemList = [];
            prodServiceCarousel = ''; 
             var servicesOwl = $('#AM_serviceCarousel');
             servicesOwl.empty();
        }
        
        function showDetail(catalogItemId)
        {
            console.log("SHOW DETAIL");
            startLoading();
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.getProductDetail}',
                catalogItemId,
                function(result, event)
                {
                    console.log(result);
                    $("#AM_documentToAppend").append(result);
                    endLoading();
                },
                {escape:false}  
            ) 
        } 
        

        function openCategoryTab(categoryTabId)
        {
            console.log("*** OPEN TAB ***   ");
            console.log(categoryTabId);
            var currentId = categoryTabId.substring(11,categoryTabId.lenght);
            console.log(currentId);
            $('.AM_tbody').addClass('AM_dispNone');
            if( $('#AM_tabBody_'+currentId).hasClass('AM_dispNone') )
            { 
                $('#AM_tabBody_'+currentId).removeClass('AM_dispNone');
            }
            else 
            { 
                $('#AM_tabBody_'+currentId).addClass('AM_dispNone');
            } 
        }
        /****************************************************************************************/
        /*                             GLOBAL VARIABLES FOR API CART                            */
        /****************************************************************************************/
        var upsertStr = ''; 
        
        var listOfItemToCart = [];
        //MAP OBJ for item add to the cartSize
        var mapOfItemToCart = {
                                    catalogId   : "",
                                    categoryId  : "",
                                    productName : "",
                                    productId   : "",
                                    rootId      : "",
                                    fatherVid   : ""
                                };  
        var catId = '';             //Catalog Id of the item added to the cart
        var categId = '';           //Category Id of the item added to the cart
        var productFather = '';     //CatlogItemId Type 'Product' of the father 
        var rootIdFather = '';      //CatlogItemId Type 'Root' of the father 
        var fatherVid       = '';

        var resultString = ''; //putPutContext after retrieveComplex
        /****************************************************************************************/


        /****************************************************************************************/
        /*                                   CART FUNCTION                                      */
        /****************************************************************************************/

        var addedProducts = [];
        var product = new Object();
        var fields = new Object();
        var addedProductsToString = '';
        var vId = ''; //vid of the root product added to cart
        var context = ''; //string with the context after first upsert
        var cartService = {};
        
        var lastContext = '';
        var configurationStatus = ''; 
        
        var needConfiguration = {};
        var configurationArray = [];

        var check = true;
        function checkCompatibilitàProdotti(commodityToAdd, producttypology, addedProducts)
        {
            console.log('### checkCompatibilitàProdotti ###');
            console.log('commodityToAdd: '+commodityToAdd); 
            console.log('producttypology: '+producttypology); 
            console.log('### addedProducts ###'); 
            console.log(addedProducts);
             
            var commodityArr = []; // array of commodity object 
            var temporayVar = true;
            for(var x=0; x<addedProducts.length; x++)
            { 
                var commodityType   = addedProducts[x].fields['commodityType'];  
                var productTypology = addedProducts[x].fields['producttypology'];  
                if( commodityType != 'undefined' )//if commodity is undefined or null it is a VAS PARTNER so there aren't problem for cart compatibility
                {
                    //commodityArr.push(commodityType);
                    var commodity = new Object(); 
                    commodity.type = commodityType;
                    commodity.prodTypology = productTypology;
                    commodityArr.push(commodity);
                }
            } 
            console.log('*** Array with the commodity added to shopping cart ***');
            console.log(commodityArr);//Array with the commodity added to shopping cart 

            for(var x=0; x<commodityArr.length; x++)
            {
                console.log('###COMMODITY TYPE: '+commodityArr[x].type)
                if(commodityArr[x].type == commodityToAdd)
                { 
                	console.log('[mt]: stesso tipo di commodity');
                	$('#AM_alertCommodityType').removeClass('slds-hide');
                	$('#AM_alertProductTypology').addClass('slds-hide');
                    $("#AM_alert").addClass("slds-fade-in-open"); 
                    $("#AM_alert_backdrop").addClass("slds-backdrop--open"); 
                    temporayVar = false;
                    x = commodityArr.length;
                } 
                else if(commodityArr[x].prodTypology == 'Res' &&  (producttypology == 'Bus' || producttypology == 'Corporate'))
                { 
            		console.log('[mt]: hai RES e stai aggiungendo prodotto diverso di tipo BUSINESS:('+producttypology+')');
                	console.log(producttypology); 
                	$('#AM_alertCommodityType').addClass('slds-hide');
                	$('#AM_alertProductTypology').removeClass('slds-hide');
                	$("#AM_alert").addClass("slds-fade-in-open"); 
                    $("#AM_alert_backdrop").addClass("slds-backdrop--open"); 
                    temporayVar = false;
                    x = commodityArr.length;
                }	 
                else if((commodityArr[x].prodTypology == 'Bus' || commodityArr[x].prodTypology == 'Corporate') && producttypology == 'Res')
                {
                	 
            		console.log('[mt]: hai BUSINESS e stai aggiungendo diverso RES:('+producttypology+')');
                	$('#AM_alertCommodityType').addClass('slds-hide');
                	$('#AM_alertProductTypology').removeClass('slds-hide');
                	$("#AM_alert").addClass("slds-fade-in-open"); 
                    $("#AM_alert_backdrop").addClass("slds-backdrop--open"); 
                    temporayVar = false;
                    x = commodityArr.length; 
                } 
                else
                {
                    temporayVar = true;
                }
            }

            check = temporayVar; 
        }

        function addProdFromDetail()
        {
        	console.log('#### addProdFromDetail ####');
        	var titleId = $('#AM_ProdName').children('h2').get(0).id;
        	var cadalogItemId = titleId.substring(12,titleId.length);
        	console.log(cadalogItemId);
        	retrieveProd(cadalogItemId);
        }

        function retrieveProd(catItem)
        {
        	//get query fields values from product add button
            var catalog                     = $('#'+catItem).data("catalogid");
            var category                    = $('#'+catItem).data("categoryid"); 
            var commodityType               = $('#'+catItem).data("commodity"); 
            var prodName                    = $('#'+catItem).data("productname");
            var commProdId                  = $('#'+catItem).data("productid");
            var itemHeader                  = $('#'+catItem).data("itemheader");
            var baserecurringcharge         = $('#'+catItem).data("baserecurringcharge");
            var baseonetimefee              = $('#'+catItem).data("baseonetimefee");
            var recurringchargefrequency    = $('#'+catItem).data("recurringchargefrequency");
            var rootId                      = $('#'+catItem).data('rootid');
            var productid                   = $('#'+catItem).data("productid");
            var enginecode                  = $('#'+catItem).data("enginecode");
            var productenginecode           = $('#'+catItem).data("productenginecode");
            var deliverytype                = $('#'+catItem).data("deliverytype");
            var configurationType           = $('#'+catItem).data("configurationtype");
            var producttypology           	= $('#'+catItem).data("producttypology");


			console.log('### commodityType: '+commodityType);
			console.log('### addedProducts: ');
			console.log(addedProducts);
            checkCompatibilitàProdotti(commodityType, producttypology, addedProducts); 
            if(check == true)
            {
	            var product = new Object();
	            var fields = new Object();
	            product.catalogitemid                   = catItem;
	            product.id                              = catItem;
	            product.catalogid                       = catalog;
	            product.categoryid                      = category;
	            product.productname                     = prodName;
	            product.baserecurringcharge             = baserecurringcharge;
	            product.baseonetimefee                  = baseonetimefee;
	            product.recurringchargefrequency        = recurringchargefrequency;
	            product.qty                             = '1';
	            product.itemheader                      = itemHeader; 
	            product.rootId                          = rootId;
	            product.productid                       = productid;  
	            product.commodityType                   = commodityType;
	            product.enginecode                      = enginecode;
	            product.engineCode                      = enginecode;
	            product.productenginecode               = productenginecode;
	            product.DeliveryType                    = deliverytype;
	            product.configurationType               = configurationType;
	            product.producttypology					= producttypology;
	            fields.fields = product;
	            addedProducts.push(fields);


	            startLoading();
	            console.log('###firstRetrieve###');   
	            Visualforce.remoting.Manager.invokeAction
	            ( 
	                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.firstRetrieve}', 
	                 catalogId,  
	                 category,
	                 lastContext, 
	                 function(result,event)
	                 {
	                    console.log(result); 
	                    lastContext = JSON.stringify(result);  
	                    upsert(catItem);                    
	                 }
	            );
	        }
        }

        var mapOfConfigurationStatus = {};
        function upsert(catItem, mapOfAttribute)
        {  
             
            console.log('*** UPSERT --> adding a product to cart ***  '+catItem);   
            var catalog                     = $('#'+catItem).data("catalogid");
            var category                    = $('#'+catItem).data("categoryid"); 
            var commodityType               = $('#'+catItem).data("commodity"); 
            var prodName                    = $('#'+catItem).data("productname");
            var commProdId                  = $('#'+catItem).data("productid");
            var itemHeader                  = $('#'+catItem).data("itemheader");
            var baserecurringcharge         = $('#'+catItem).data("baserecurringcharge");
            var baseonetimefee              = $('#'+catItem).data("baseonetimefee");
            var recurringchargefrequency    = $('#'+catItem).data("recurringchargefrequency");
            var rootId                      = $('#'+catItem).data('rootid');
            var productid                   = $('#'+catItem).data("productid");
            var enginecode                  = $('#'+catItem).data("enginecode");
            var productenginecode           = $('#'+catItem).data("productenginecode");
            var deliverytype                = $('#'+catItem).data("deliverytype");
            var configurationType           = $('#'+catItem).data("configurationtype");

            console.log('###### delivery type #####'+deliverytype);
            console.log('###### configurationType #####'+configurationType);  
            var ordId = '{!ordId}'; 
                
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.newUpsert}', 
                 catItem,
                 ordId,
                 lastContext,
                 //addedProductsToString,
                 catalog,
                 category, 
                 function(result,event)
                 { 
                    lastContext = ''; 
                    console.log('### RESULT OF UPSERT ###');
                    console.log(result);
                    // console.log('### CONFIGURATION STATUS ###')
                    // console.log(result.configuration);
                    // console.log(result.configuration.NE__ConfigurationStatus__c);

                    var configurationStatus = result.configuration.NE__ConfigurationStatus__c;
                    mapOfConfigurationStatus[prodName] = configurationStatus;
                    lastContext = JSON.stringify(result);  
                    var cartSize = result.cart.length;   
                    
                    if( cartSize > 0 )
                    { 
                        $('#AM_prodInCart').text('( '+cartSize+' )');
                    } 
                    else if( cartSize == 0)
                    {
                        $('#AM_summarySection').addClass('AM_dispNone');
                    } 
                    endLoading();  
                    buildSummary(configurationStatus); 
                 } 
            ); 
        }
         
        var messList = [];
        function buildSummary(configurationStatus) 
        {  
            var listToAppend = ''; 
            $('#AM_cartSummary').empty(); 
            
            //***************************************************************//
            //                        MESSAGE SECTION                        //
            //***************************************************************//
            
            $('#AM_cartMsg').empty();
            var lastContextObj = JSON.parse(lastContext);
            if(lastContextObj.messages.length > 0)
            {
                for(var x = 0; x<lastContextObj.messages.length; x++)
                { 
                    var text = lastContextObj.messages[x].text;
                    var type = lastContextObj.messages[x].type;  
                    var splitText = text.split(":"); 
                    var newText = '{!$Label.ITA_IFM_AM_SummaryMessage}' +splitText[0];
                    messList.push(newText);
                    $('#AM_cartMsg').append('<div class="slds-card slds-theme--error slds-theme--alert-texture slds-text-align--center"><div class="slds-grid"><i class="fa fa-2x fa-exclamation-triangle"></i><p>'+newText+'</p></div></div>');
                    $('#AM_cartMsg').removeClass('slds-hide');
                }
            } 
             
            console.log('### Lista Messaggi ###');
            console.log(messList);
            //***************************************************************//
            //             LIST OF SUMMARY PRODUCT SECTION                   //
            //***************************************************************//
            for(var i = 0; i<lastContextObj.cart.length; i++)
            {
                var prodName        = lastContextObj.cart[i].fields['productname'];
                var catalogItemId   = lastContextObj.cart[i].fields['catalogitemid'];
                var categoryId      = lastContextObj.cart[i].fields['categoryid'];
                var categoryName    = lastContextObj.cart[i].fields['categoryname'];
                var itemCode        = lastContextObj.cart[i].fields['itemCode']; 
                var rootid          = lastContextObj.cart[i].fields['itemcode']; 

                //var commodityType     = lastContextObj.cart[i].fields['commodityType']; 
                //var rootid            = addedProducts[i].fields['rootId']; 
                // if( categoryName != 'Beni' )
                // {
                    listToAppend += '<li id="AM_liSummary_'+catalogItemId+'" data-commodity="'+categoryName+'" class="slds-item slds-grid slds-grid--align-space">';
                    listToAppend += '<div class="slds-grid slds-medium-size--6-of-6 slds-large-size--12-of-12  ">'; 
                    listToAppend += '<div class="slds-medium-size--4-of-6 slds-large-size--9-of-12">'
                    listToAppend += '<div class="slds-grid"><p class="slds-section__title"><strong>'+prodName+'</strong></p></div>'; 
                    listToAppend += '<div class="slds-grid"><p class="slds-section__title">  ('+categoryName+')</p></div>';
                    listToAppend += '</div>';
                // }
                // else
                // {
                //     listToAppend += '<li id="AM_liSummary_'+catalogItemId+'" data-commodity="'+categoryName+'" class="slds-item slds-grid slds-grid--align-space">';
                //     listToAppend += '<div class="slds-text-title"><p class="slds-section__title">'+prodName+'</p></div>'; 
                // }
 
 				//finding complex or simple product 
 				if(lastContextObj.cart[i].fields['itemheader'] != null && lastContextObj.cart[i].fields['itemheader'] != '')
        		{
        			console.log('### PRODOTTO COMPLESSO: '+lastContextObj.cart[i].fields['productname']);
        			listToAppend += '<div class="slds-medium-size--2-of-6 slds-large-size--3-of-12"><button id="AM_addedCatItem_'+catalogItemId+'" class="slds-button slds-button--icon slds-button--icon-small slds-col--bump-left AM_bumpLeft" data-category="'+categoryId+'" data-rootid="'+rootid+'" data-itemcode="'+itemCode+'" onClick="productConfiguration(this.id)">';
                	listToAppend += '<i class="fa fa-wrench fa-2x"></i></button>'; 
        		} 
               
                listToAppend += '<button id="AM_removeCatItem_'+catalogItemId+'" class="slds-button slds-button--icon slds-button--icon-small" data-category="'+categoryId+'" onClick="removeItemFormSummaryCart(this.id)"><i class="fa fa-trash fa-2x" ></i></button></div>';
                listToAppend += '</li>';
            } 

            //***************************************************************//
            //                     CONFIGURATION SECTION                     //
            //***************************************************************//
            var confStatusStr = '';
            $('#AM_configurationStatus').empty();
            if(configurationStatus == 'Valid')
            {
                console.log('### valid');
                confStatusStr = '<h3 class="slds-text-heading--medium AM_colorGreen"><strong>'+configurationStatus+'</strong></h3>';
                $('#AM_checkOutButton').removeClass('AM_disabled').addClass('slds-button--brand'); 
                $('#AM_checkOutButton').prop("disabled", false);
            }
            else if(configurationStatus == 'In progress')
            {
                console.log('### in progress');
                confStatusStr = '<h3 class="slds-text-heading--medium AM_colorRed"><strong>'+configurationStatus+'</strong></h3>';
                $('#AM_checkOutButton').addClass('AM_disabled').removeClass('slds-button--brand'); 
                $('#AM_checkOutButton').attr('disabled','disabled');  
            } 
            $('#AM_configurationStatus').append(confStatusStr);


            console.log('lastcontext');
            var jsonContext = JSON.parse(lastContext); 
            $('#AM_cartSummary').append(listToAppend);
            $('#AM_one').empty().append(jsonContext.configuration.NE__One_Time_Fee_Total__c+'<i class="fa fa-eur"></i>');
            $('#AM_recurring').empty().append(jsonContext.configuration.NE__Recurring_Charge_Total__c+'<i class="fa fa-eur"></i>/'+jsonContext.configuration.NE__TotalRecurringFrequency__c);  
        } 


        //var fatherCategoriesList = []; 
        function productConfiguration(buttonId)
        {
            console.log('*** PRODUCT CONFIGURATION ***'+buttonId);   
            $("#AM_summarySection").addClass("slds-hide");   
            startLoading();

            var catItem = buttonId.substring(16, buttonId.length); 
            var families = []; //array for families not hidden of the selected product 
            var famString = '';
            var attrString = '';
            var familySet = new Set(); 
            var fatherVid = '';  
           

            //******************** immagine dal catalogo **********************//
            console.log('### IMMAGINE PRODOTTO DAL CATALOGO ###');
            var iconProd = $('#AM_iconProd_'+catItem).attr('class');
            console.log('**** iconProd '+iconProd);
            var iconProdSmall = iconProd+'_Small';
            //*****************************************************************// 
            var catalog = $('#'+catItem).data("catalogid");
            var category = $('#'+catItem).data("categoryid");
            var rootId = $('#'+catItem).data("rootid");  
            console.log('rootId: '+rootId);            

            var productName = $('#AM_prodTitle_'+catItem).text();
            console.log('*** Product: '+productName);
            var currentItemCode = $('#'+buttonId).data('itemcode'); 

            //**********************************************************************//
            //                        CONFIGURATION TITLE                           //
            //**********************************************************************//  
            $("#AM_configurationProd").empty(); 
            var imgSrc = $('#AM_ProductImg_'+catItem).attr('src'); 
            var imgStr = '<img class="AM_thumbnail slds-icon slds-icon--medium slds-icon_container" src="'+imgSrc +'"/>';  
            var prodTitle = ''; 
            var childProdTitle = ''; 
            prodTitle += '<div id="AM_productRoot_'+catItem+'" class="slds-grid slds-medium-size--6-of-6 slds-large-size--12-of-12" onClick="backToFatherConfiguration(this.id)">'+imgStr + '<h2 id="AM_extProduct" class="slds-p-around--small slds-text-heading--medium" data-parentitemcode="'+currentItemCode+'" data-item="'+catItem+'" data-category="'+category+'">'+productName+'</h2></div>';  
            $("#AM_configurationProd").append(prodTitle);   

            $('#tab-scoped-1').addClass('slds-show').removeClass('slds-hide');
            $('#AM_itemOne').addClass('slds-active'); 
             
			//**********************************************************************//  
			//																		//
			//**********************************************************************// 
            
            Visualforce.remoting.Manager.invokeAction 
            (
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.retrieveFamilyNotHidden}',
                catItem,
                function(result,event)
                {
                    console.log('### RESULT OF RETRIEVE FAMILY NOT HIDDEN ###');
                    console.log(result);
                    console.log('###category; '+category);
                    families = result; //populate the array with not hidden family of the product
                    Visualforce.remoting.Manager.invokeAction
                    ( 
                        '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.retrieveComplex}',
                        orderId,
                        catalogId,
                        category,
                        lastContext, 
                        currentItemCode,
                        function(result, event)
                        {
                            console.log('### RESULT OF RETRIEVE COMPLEX ####');
                            console.log(result); 
                            lastContext = '';  
                            lastContext = JSON.stringify(result);   

                            //**********************************************************************//
                            //                       BUILD MESAGGES SECTION                         //
                            //**********************************************************************//
                            updateMessage(result); 
                            //**********************************************************************//
                            //                        BUILD CATEGORY SECTION                        //
                            //**********************************************************************// 
                            //svuota fatherCategoriesList ogni volta che apro un prodotto padre//
                            //fatherCategoriesList = [];
                            var fatherCategory = {};
                            // console.log('*** fatherCategoriesList before ***'); 
                            // console.log(fatherCategoriesList);
                            $("#AM_leftNavBar").empty();//MT modified 22 dic 2016
                            $("#AM_attributesDiv").empty();//MT modified 22 dic 2016
                            for(var x = 0; x<result.cart.length; x++)
                            {
                                var liStr = ''; //string to append LI for categories TAB!
                                liStr += '<ul id="AM_categoryTabs" class="slds-has-dividers--bottom-space">'; 
                                for(var x = 0; x<result.listOfCategories.length; x++)   
                                { 
                                    var categoryId = result.listOfCategories[x].categoryFields['id'];
                                    var categoryName = result.listOfCategories[x].categoryFields['categoryname'];
                                    var minQty = result.listOfCategories[x].categoryFields['minqty'];
                                    var maxQty = result.listOfCategories[x].categoryFields['maxqty'];
                                    console.log('***NOME CATEGORY ***: '+categoryName +'*** min qty:' +minQty+'  *** max qty:' +minQty);


                                    fatherCategory.catalogId = catalog;
                                    fatherCategory.catalogItemId = catItem;
                                    fatherCategory.catId = result.listOfCategories[x].categoryFields['id'];  
                                    fatherCategory.catName = result.listOfCategories[x].categoryFields['categoryname'];  
                                    fatherCategory.minQty = minQty; 
                                    fatherCategory.result = result;
                                    fatherCategory.faterVid = fatherVid;  
                                    fatherCategory.cartService = cartService;//unico per prodotto padre aggiunto
                                    //fatherCategoriesList.push(fatherCategory); 

                                    //***********************************************************//
                                    //          BUILD LIST OF CATEGORY BY NAME                  //
                                    //***********************************************************//
                                    if(minQty>0)
                                    { 
                                        liStr += '<li id="AM_categName_'+categoryId+'" class="slds-item">'; 
                                        liStr += '<div class="slds-grid">';
                                        liStr += '<button id="AM_tab_'+categoryId+'" class="slds-button slds-button--icon slds-button--icon-small " onclick="openCategory(this.id)"><i class="fa fa-chevron-right fa-2x AM_colorRed AM_chevron" ></i></button>';
                                        liStr += '<p id="AM_categoryName" class="slds-text-title--caps">'+categoryName+'</p>';  
                                        liStr += '</div></li>';

                                 		$('#AM_envelopeMsg_section').css('display', 'block')

                                 		var str = '';
                                		var blancSpace = '  ';
                                		str += '<li class="slds-item slds-grid slds-grid--align-space">'; 
                                		str += '<div class="slds-text-title AM_borderMess"><p class="slds-section__title AM_colorRed">';
                                		str += '{!$Label.ITA_IFM_requiredMsg1}'+blancSpace+categoryName+blancSpace+'{!$Label.ITA_IFM_requiredMsg2}';
                                		str += '</p></div></li>';
                                		$('#AM_messageList').append(str);
                                		if( $('#AM_envelopeMsg').text() == '(0)' )
                                		{ 
	                                		$('#AM_envelopeMsg').text('(1)'); 
	                                		$('.fa-envelope-o').addClass('AM_colorRed');
	                                		$('.fa-exclamation').removeClass('slds-hide');
                                		}
                                		else
                                		{
                                			var n = $('#AM_envelopeMsg').text().match(/\d+/g);
                                			n++;
                                			$('#AM_envelopeMsg').text(n);
                                		} 
                                    }
                                    else
                                    {
                                        liStr += '<li id="AM_categName_'+categoryId+'" class="slds-item AM_list">'; 
                                        liStr += '<div class="slds-grid">';
                                        liStr += '<button id="AM_tab_'+categoryId+'" class="slds-button slds-button--icon slds-button--icon-small" onclick="openCategory(this.id)"><i class="fa fa-chevron-right fa-2x AM_chevron" ></i></button>';
                                        liStr += '<p id="AM_categoryName" class="slds-text-title--caps">'+categoryName+'</p>'; 
                                        liStr += '</div></li>'; 
                                    } 
                                }
                                liStr +='</ul>';  
                                $("#AM_leftNavBar").append(liStr);

                                // console.log('*** fatherCategoriesList AFTER ***'); 
                                // console.log(fatherCategoriesList);
                                //***********************************************************//
                                //                 BUILD LIST CHILD ITEMS                    //
                                //***********************************************************//
                                for(var x = 0; x<result.listOfCategories.length; x++)   
                                { 
                                    var categoryId = result.listOfCategories[x].categoryFields['id'];
                                    var liStr2 = '';
                                    liStr2 = '<ul class="AM_categItemTabs slds-has-dividers--bottom slds-hide">';
                                    for(var y = 0; y<result.listOfItems.length; y++)
                                    {
                                        var childMinQty = result.listOfItems[y].fields['minqty'];
                                        var childMaxQty = result.listOfItems[y].fields['maxqty'];  
                                        
                                        if( result.listOfItems[y].fields['parent'] == categoryId )
                                        {
                                            //console.log('***NOME FIGLIO: '+result.listOfItems[y].fields['productname']);

                                            liStr2 += '<li id="AM_categItem_'+result.listOfItems[y].fields['catalogitemid']+'" class="slds-item AM_list2" data-productname ="'+result.listOfItems[y].fields['productname']+'" data-parentvid="'+result.listOfItems[y].fields['parentvid']+'" data-itemCode="'+result.listOfItems[y].fields['itemCode']+'" data-catalogid="'+result.listOfItems[y].fields['catalogid']+'" data-categoryid="'+categoryId+'" data-fatherItemCode="'+currentItemCode+'" data-rootvid="'+result.listOfItems[y].fields['rootvid']+'" data-minqty="'+childMinQty+'" data-maxqty="'+childMaxQty+'">';  
                                         
                                            if( childMinQty == 0 && childMaxQty == 1 )
                                            {
                                                console.log('*** radiobutton ***');
                                                liStr2 += '<div class="slds-grid">';
                                                liStr2 += '<p class="slds-form-element__label slds-text-title--caps AM_fontSize1x">'+result.listOfItems[y].fields['productname']+'</p>';  
                                                liStr2 += '<div class="slds-col--bump-left">';
                                                liStr2 += '<button id="AM_childId_'+result.listOfItems[y].fields['catalogitemid']+'" class="slds-button slds-button--icon" onClick="addChildProduct(this.id)" data-categoryid="'+categoryId+'" style="margin-rigtht: 5%"><i class="fa fa-2x fa-plus"></i></button></div>';
                                                liStr2 += '</div>';
                                            }
                                            else if ( childMinQty == 0 && childMaxQty == 999 )
                                            {
                                                console.log('*** contatore ***');
                                                liStr2 += '<div class="slds-grid">'; 
                                                liStr2 += '<div class="slds-grid slds-medium-size--4-of-6 slds-large-size--7-of-12">'
                                                liStr2 += '<p class="slds-form-element__label slds-text-title--caps AM_fontSize1x">'+result.listOfItems[y].fields['productname']+'</p></div>';
                                                liStr2 += '<div class="slds-grid slds-medium-size--2-of-6 slds-large-size--5-of-12 slds-grid--align-end">'; 
                                                liStr2 += '<button id="AM_minus_'+result.listOfItems[y].fields['catalogitemid']+'" class="slds-button slds-button--icon" onClick="minus(this.id)" style="margin-right:5%"><i class="fa fa-2x fa-minus"></i></button>';  
                                                liStr2 += '<input id="AM_inputQty_'+result.listOfItems[y].fields['catalogitemid']+'" class="slds-input" type="number" pattern="\d*" style="width:35%" value="'+childMinQty+'"/>';
                                                liStr2 += '<button id="AM_plus_'+result.listOfItems[y].fields['catalogitemid']+'" class="slds-button slds-button--icon" onClick="plus(this.id)" style="style="margin-left:5%" margin-right:10%"><i class="fa fa-2x fa-plus"></i></button>';
                                                liStr2 += '<button id="AM_childId_'+result.listOfItems[y].fields['catalogitemid']+'" data-categoryid="'+categoryId+'" class="slds-button slds-button--icon" onClick="addChildProduct(this.id)" style="margin-left:5%"><i class="fa fa-2x fa-shopping-cart"></i></button></div>';  
                                                liStr2 += '</div>'; 
                                                liStr2 += '<div style="border-top: 2px solid; margin-top: 2%;">';
                                                liStr2 += '<div class="slds-grid"><p><i class="fa fa-eur"></i>'+result.listOfItems[y].fields['baseonetimefee']+'</p></div>';  
                                                liStr2 += '<div class="slds-grid"><p><i class="fa fa-eur"></i>'+result.listOfItems[y].fields['baserecurringcharge']+'/Monthly<p></div>';  
                                                liStr2 += '</div>';
                                                
                                            }
                                            else if ( childMinQty == 1 && childMaxQty == 1 )
                                            { 
                                                console.log('*** prodotto autoadd di default ***');
                                                liStr2 += '<div class="slds-grid">'; 
                                                liStr2 += '<div class="slds-grid slds-medium-size--4-of-6 slds-large-size--7-of-12">';
                                                liStr2 += '<p class="slds-form-element__label slds-text-title--caps AM_fontSize1x">'+result.listOfItems[y].fields['productname']+'</p>';
                                                liStr2 += '</div>';
                                                liStr2 += '<div class="slds-grid slds-col--bump-left">';  
                                                liStr2 += '<div class="slds-align-middle" style="margi-right:20%;">';
                                                liStr2 += '<input type="checkbox" name="options" disabled="" checked=""/></div>';
                                                liStr2 += '<button id="AM_childId_'+result.listOfItems[y].fields['catalogitemid']+'" data-categoryid="'+categoryId+'" class="slds-button slds-button--icon" onClick="updateChildAutoAdded(this.id)"><i class="fa fa-2x fa-wrench"></i></button>';
                                                liStr2 += '</div></div></div>';
                                            }
                                            liStr2 += '</li>';   
                                        }
                                        else
                                        {
                                            console.log('---');
                                        } 
                                    } 
                                    liStr2 + '</ul>'; 
                                    $("#AM_categName_"+categoryId).append(liStr2);
                                    liStr2 = '';  
                                } 
                            }

                            //**********************************************************************//
                            //                     BUILD ATTRIBUTES SECTION                         //
                            //**********************************************************************// 
                            $('#AM_childAttrContent').empty();
                            for(var x = 0; x<result.cart.length; x++)
                            {  
                                if(result.cart[x].fields['catalogitemid'] == catItem)
                                {
                                    var childItemListSize = result.cart[x].childItems.length;
                                    var listOfAttributes = result.cart[x].listOfAttributes;
                                    for(var z = 0; z<listOfAttributes.length; z++)
                                    {
                                        var req = listOfAttributes[z].fields['required'];
                                        var hidden = listOfAttributes[z].fields['hidden'];
                                        var attrName = listOfAttributes[z].fields['name']; 
                                        var idattr = listOfAttributes[z].fields['idattr']; 
                                        var familyName = listOfAttributes[z].fields['familyname']; 
                                        var idfamily = listOfAttributes[z].fields['idfamily']; 
                                        var attrRequired = listOfAttributes[z].fields['required'];
                                        
                                        console.log('families array');
                                        console.log(families);
                                        console.log('familySet');
                                        console.log(familySet);
                                        for(var n = 0; n<families.length; n++)
                                        {    
                                            if(families[n].NE__FamilyId__c == idfamily)
                                            {  
                                                if( familySet.has(idfamily) )
                                                { 
                                                    if(attrRequired == "Yes")
                                                    {
                                                        attrString = attrString + '<div id ="AM__attrId_'+idattr+'"><abbr class="slds-required">*</abr>'+attrName+'</div>'; 
                                                    }
                                                    else
                                                    {
                                                        attrString = attrString + '<div id ="AM__attrId_'+idattr+'">&nbsp'+attrName+'</div>'; 
                                                    } 
                                                    $("#AM_famId_"+idfamily).append(attrString);
                                                    attrString = '';
                                                }
                                                else if( !familySet.has(idfamily)  )
                                                {
                                                    
                                                    familySet.add(idfamily);
                                                    famString = '';
                                                    famString = famString + '<li id="AM_famId_'+idfamily+'" data-categoryId="'+category+'" class="slds-item"><p class="slds-text-title--caps">'+familyName+'</p></li>';
                                                    if(attrRequired=="Yes")
                                                    {
                                                        attrString += '<div id ="AM__attrId_'+idattr+'"><abbr class="slds-required">*</abr>'+attrName+'</div>'; 
                                                    }
                                                    else
                                                    {
                                                        attrString += '<div id ="AM__attrId_'+idattr+'">&nbsp'+attrName+'</div>'; 
                                                    } 
                                                    $("#AM_attributesDiv").append(famString); 
                                                    $("#AM_famId_"+idfamily).append(attrString);
                                                    attrString = '';
                                                } 
                                            }
                                        }
                                        attrString =+ '</ul>'; 
                                        //$("#AM_leftSide").append(attrString);  

                                        var selectVal = '<div class="slds-form-element">';
                                        selectVal += '<div class="slds-form-element__control">';
                                        selectVal += '<div class="slds-select_container">'; 

                                        var settedValueAttr     =   listOfAttributes[z].fields['value']; 
                                        var readOnlyAttr        =   listOfAttributes[z].fields['readonly']; 
                                        
                                        console.log(listOfAttributes[z].listOfDomains);
                                        if( listOfAttributes[z].fields['type'] == 'Enumerated' )
                                        {
                                            console.log('PickList');
                                            selectVal += '<select id="AM_selectAttr_'+idattr+'" class="slds-select" onchange="changeAttribute()">';
                                            selectVal += '<option>-----</option>';
                                            for(var y = 0; y<listOfAttributes[z].listOfDomains.length; y++)
                                            {  
                                                var valueAttr = listOfAttributes[z].listOfDomains[y].fields['label']; 
                                                console.log('valueAttr'); 
                                                console.log(valueAttr); 
                                                selectVal += '<option>'+valueAttr+'</option>';
                                            } 
                                        }
                                        selectVal += '</select></div></div></div>'; 
                                        $("#AM_famId_"+idfamily).append(selectVal);


                                        if(settedValueAttr != '' && settedValueAttr != null && !(typeof settedValueAttr === "undefined"))
                                        { 
                                            console.log('### attribute not empty ###')
                                            $("#AM_selectAttr_"+idattr).val(settedValueAttr);
                                            if(readOnlyAttr == 'Yes')
                                            {
                                                console.log('### attribute read only ###');
                                                $("#AM_selectAttr_"+idattr).attr('disabled','disabled');
                                            }
                                        } 
                                        selectVal = '';
                                        x =result.cart.length;
                                    }
                                } 
                                endLoading();   
                                openCartSection(productName, childItemListSize);  //method to open the configuration Product Section (into the cart)
                            }
                        }
                    );
                }
            );
        } 

        function backToFatherConfiguration(catItem)
        {
            console.log('*** backToFatherConfiguration ***');
            var catalogItemId = catItem.substring(15,catItem.length);  
            console.log(catalogItemId);
            $('#AM_attributesContainer').removeClass('slds-hide');
            $('#AM_childAttrContent').addClass('slds-hide');
        }

        function updateMessage(contextObject)
        {
        	console.log('### updateMessage ###');
        	if(contextObject.messages.length > 0 )
            { 
                $('#AM_messageList').empty();
                $('.fa-envelope-o').addClass('AM_colorRed');
                $('.fa-exclamation').removeClass('slds-hide');
                $('#AM_envelopeMsg_section').css('display', 'block');
                $('#AM_envelopeMsg').text('  ('+contextObject.messages.length+')  ');
                var str = '';
                for( var i = 0; i<contextObject.messages.length; i++)
                {
                    console.log('### section messages ###');
                    console.log(contextObject.messages[i]);
                    console.log(contextObject.messages[i].text); 
                    $('#AM_messageList').empty();  
                    str += '<li class="slds-item slds-grid slds-grid--align-space">';
                    str += '<div class="slds-text-title AM_borderMess"><p class="slds-section__title AM_colorRed">'+contextObject.messages[i].text+'</p></div></li>';
                    $('#AM_messageList').append(str);
                }
            }
            else
            {
                $('#AM_envelopeMsg_section').css('display', 'none');
                $('.fa-exclamation').addClass('slds-hide');
                $('.fa-envelope-o').removeClass('AM_colorRed');
                $('#AM_envelopeMsg').text('('+contextObject.messages.length+')');
            } 

            if(contextObject.configuration.NE__ConfigurationStatus__c == 'Valid')
            {
            	$('#AM_esitoStatus').children('strong').remove();
            	$('#AM_esitoStatus').append('<strong class="AM_colorGreen">'+contextObject.configuration.NE__ConfigurationStatus__c+'</strong>'); 
            	$('#AM_configurationStatus').children('h3').children('strong').remove();
            	$('#AM_configurationStatus').children('h3').append('<strong class="AM_colorGreen">'+contextObject.configuration.NE__ConfigurationStatus__c+'</strong>'); 
            	//save button not disabled
            	console.log('Valid');
            	$('#AM_next').removeClass('AM_disabled').addClass('slds-button--brand'); 
                $('#AM_next').prop("disabled", false);
            }
            else
            {
            	$('#AM_esitoStatus').children('strong').remove();
            	$('#AM_esitoStatus').append('<strong class="AM_colorRed">'+contextObject.configuration.NE__ConfigurationStatus__c+'</strong>');
            	$('#AM_configurationStatus').children('h3').children('strong').remove();
            	$('#AM_configurationStatus').children('h3').append('<strong class="AM_colorGreen">'+contextObject.configuration.NE__ConfigurationStatus__c+'</strong>'); 
            	//save button disabled
            	console.log('IN PROGRESS');
            	$('#AM_next').addClass('AM_disabled').removeClass('slds-button--brand'); 
                $('#AM_next').prop("disabled", true);
            } 
        }  

        function addChildProduct(buttonId)
        { 
            console.log('### ADD CHILD PRODUCT ### button id: '+buttonId); 
            var idChild = buttonId.substring(11,buttonId.length);  
            console.log(idChild);

            $('#AM_childAttrContent').empty();
            var parentItemdCode     = $('#AM_extProduct').data('parentitemcode');
            var childMinQty         = $('#AM_childId_'+idChild).data('minqty');
            var childMaxQty         = $('#AM_childId_'+idChild).data('maxqty');
            var childname           = $('#AM_childId_'+idChild).data('childname');
            var baseonetimefee      = $('#AM_childId_'+idChild).data('baseonetimefee');
            var baserecurringcharge = $('#AM_childId_'+idChild).data('baserecurringcharge');

            var standardQty = '1';  
            
            var qty = $('#AM_inputQty_'+idChild).val();
            if( typeof qty === "undefined")  
            {
                qty = standardQty;
                console.log('***fake qty = '+qty); 
            }
            else
            {
                console.log('***input qty = '+qty);
            }
            
            
            if( qty == null || qty == '' || qty == 0 )
            {
                console.log('##### quantità NON POPOLATA ####');
                $("#AM_alertQty").addClass("slds-fade-in-open"); 
                $("#AM_alert_backdrop_qty").addClass("slds-backdrop--open"); 
            }
            else
            {
                console.log('##### quantità aggiunta = '+qty);
                var categoryid = $("#AM_categItem_"+idChild).data('categoryid');  
                //var parentItemdCode = $("#AM_categItem_"+idChild).data('parentvid'); 
                var parentvid = $("#AM_categItem_"+idChild).data('fatheritemcode'); 
                var fatherId = $("#AM_extProduct").data("item"); 

             
                var childName = $('#AM_categItem_'+idChild).data('productname');
                var rootVid     = $("#AM_categItem_"+idChild).data('rootvid'); 
                $('#AM_categItem_'+idChild).addClass('AM_selected');

                console.log('parentitemcode: '+parentItemdCode);
                startLoading();


                Visualforce.remoting.Manager.invokeAction
                ( 
                    '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.upsertChildItems}',
                    catalogId,
                    categoryid,  
                    idChild, 
                    lastContext,
                    qty,
                    //parentItemdCode,
                    rootVid,
                    parentvid,
                    function(result,event)
                    {
                        lastContext = '';
                        lastContext = JSON.stringify(result);  
                        console.log(result); 

                        $("#AM_esitoStatus strong").empty();
                        var configurationStatus = result.configuration.NE__ConfigurationStatus__c; 
                        if( configurationStatus == 'Valid')
                        {
                            $("#AM_esitoStatus").append('<strong class="AM_colorGreen">'+configurationStatus+'</strong>'); 
                            $('#AM_checkOutButton').removeClass('AM_disabled').addClass('slds-button--brand'); 
                            $('#AM_checkOutButton').prop("disabled", false);
                            $('#AM_configurationStatus').empty();
                            $('#AM_configurationStatus').append('<h3 class="slds-text-heading--medium AM_colorGreen"><strong>'+configurationStatus+'</strong></h3>');
                            $('#AM_cartMsg').empty();
                            $('.fa-envelope-o').removeClass('AM_colorRed');
                            $('.fa-envelope-o').removeClass('AM_colorRed');
                            $('#AM_cartMsg.css').css('display', 'none');
                            $('#AM_envelopeMsg').empty().text('  (0)  ');
                        }   
                        else
                        {
                            $("#AM_esitoStatus").append('<strong class="AM_colorRed">'+configurationStatus+'</strong>'); 
                        }

                        lastContext = JSON.stringify(result);  

                        //**********************************************************************//
                        //                       BUILD MESAGGES SECTION                         //
                        //**********************************************************************//  
                        updateMessage(result);  
						//**********************************************************************// 

                        $('#AM_childAttrContent').empty();
						$('#AM_extChildProduct').empty();   

                        var stringToAppend = ''; 
                        stringToAppend += '<div class="AM_successTheme slds-grid slds-text-align--center slds-theme--success slds-theme--alert-texture">'; 
                        stringToAppend += '<i class="fa fa-2x fa-info-circle"></i>';
                        stringToAppend += '<h2 id="AM_extChildProduct"><strong>'+childName+'</strong>';
                        stringToAppend += '\xa0\xa0\xa0\xa0\xa0'+'{!$Label.ITA_IFM_AM_isInTheCart}</h2></div>'; 
                         
                        for(var x=0; x<result.cart.length; x++)
                        {
                            console.log('#### fatherId'+fatherId);
                            console.log('###  catalogitemid'+result.cart[x].fields['catalogitemid']);
                            if( result.cart[x].fields['catalogitemid'] == fatherId )
                            {
                                console.log('*** found father **');
                                console.log('*** unmber of child added: '+result.cart[x].childItems.length);
                                var childList       = result.cart[x].childItems; 
                                var childQty        = childList.length; 
                                for(var y=0; y<childList.length; y++)
                                { 
                                    if( childList[y].fields['catalogitemid'] == idChild)
                                    {
                                        console.log('*** found child *** --->'+childList[y].fields['productname']); 
                                        var listOfAttr     = childList[y].listOfAttributes;
	                            		var listOfFamilies = childList[y].listOfFamilies;
                                        Visualforce.remoting.Manager.invokeAction 
							            (
							                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.retrieveFamilyNotHidden}',
							                idChild,
							                function(result,event)
							                { 
							                	if(result!=null && result!='')
							                	{ 
							                		stringToAppend += '<ul class="slds-has-dividers--bottom-space">';   
							                		for(var z=0; z<listOfAttr.length; z++ )
			                                        {
			                                            var idAttr   = listOfAttr[z].fields['idattr'];
			                                            var idFamily = listOfAttr[z].fields['idfamily'];
			                                            var attrName = listOfAttr[z].fields['name'];
			                                            var req      = listOfAttr[z].fields['required'];
			                                            var readonly = listOfAttr[z].fields['readonly'];
			                                            var type     = listOfAttr[z].fields['type'];
			                                            var value    = listOfAttr[z].fields['value'];

			                                            stringToAppend += '<li id="AM_liChildAttr'+idAttr+'" class="slds-item">'; 
			                                            if( req == 'Yes')
			                                            {
			                                                stringToAppend += '<div id="AM_childAttr'+idAttr+'"><abbr class="slds-required">*</abr>'+attrName+'</div>';
			                                            }
			                                            else
			                                            {
			                                                stringToAppend += '<div id="AM_childAttr'+idAttr+'">'+attrName+'</div>';
			                                            }

			                                            stringToAppend += '<div class="slds-form-element">';
			                                            stringToAppend += '<div class="slds-form-element__control slds-grid">';

			                                            if( type == 'String' )
			                                            {
			                                                if(attrName.indexOf('cellulare')>0)
			                                                {
			                                                    console.log('Type input---cellulare'); 
			                                                    if( readonly == 'No')
			                                                    {
			                                                    	stringToAppend += '<input id="AM_cell_'+idAttr+'" class="slds-input" type="number"/>';
			                                                    }
			                                                    else
			                                                    {
			                                                    	stringToAppend += '<input id="AM_cell_'+idAttr+'" class="slds-input" type="number" disabled="true"/>';
			                                                    }
																stringToAppend += '<i class="fa fa-check-circle" style="margin-left:2%"></i>';
			                                                    
			                                                }
			                                                else if(attrName.indexOf('mail')>0)
			                                                {
			                                                    console.log('Type input---email');
			                                                    if( readonly == 'No')
			                                                    {
			                                                    	stringToAppend += '<input id="AM_email_'+idAttr+'" data-childId="'+idChild+'" class="slds-input" type="email" onblur="validateEmail(this.id)"/>';
			                                                    }
			                                                    else
			                                                    {
			                                                    	stringToAppend += '<input id="AM_email_'+idAttr+'" data-childId="'+idChild+'" class="slds-input" type="email" onblur="validateEmail(this.id)" disabled="true"/>';
			                                                    } 
			                                                    stringToAppend += '<i id="AM_check_'+idAttr+'" class="fa fa-2x AM_colorGreen fa-check-circle slds-hidden" style="margin-left:2%"></i>';
			                                                    stringToAppend += '<i id="AM_stop_'+idAttr+'" class="fa fa-2x AM_colorRed fa-times-circle slds-hidden" style="margin-left:2%"></i>';
			                                                } 
			                                                else
			                                                {
			                                                	if( readonly == 'No')
			                                                    {
			                                                    	stringToAppend += '<input data-childId="'+idChild+'" class="slds-input" type="text"/>';
			                                                    }
			                                                    else
			                                                    {
			                                                    	stringToAppend += '<input data-childId="'+idChild+'" class="slds-input" type="text" disabled="true"/>';
			                                                    }  
			                                                    stringToAppend += '<i id="AM_check_'+idAttr+'" class="fa fa-2x AM_colorGreen fa-check-circle slds-hidden" style="margin-left:2%"></i>';
			                                                    stringToAppend += '<i id="AM_stop_'+idAttr+'" class="fa fa-2x AM_colorRed fa-times-circle slds-hidden" style="margin-left:2%"></i>';
			                                                }
			                                            }
			                                            else if( type=='Enumerated')
			                                            {                                        
			                                                console.log('Type picklist'); 
			                                            }

			                                            stringToAppend += '</div></div></li>';
			                                        } 
		                                        }  
					                            $('#AM_childAttrContent').append(stringToAppend);
					                            $("#AM_attributesContainer").addClass("slds-hide");
					                            $("#AM_childAttrContent").removeClass("slds-hide");
					                            $("#AM_prodSummary").empty();
					                            $("#AM_prodSummary").text('SUMMARY  ('+childQty+')');
					                            endLoading();
					                        }
					                    );
 									}
								} 
							}
						}
					}
				);
			}
        }       

        function buildChildAttributeForm(contextObj, fatherId, idChild)
        {
        	for(var x=0; x<contextObj.cart.length; x++)
            {
                console.log('#### fatherId'+fatherId);
                console.log('###  catalogitemid'+contextObj.cart[x].fields['catalogitemid']);
                if( contextObj.cart[x].fields['catalogitemid'] == fatherId )
                {
                    console.log('*** found father **');
                    console.log('*** unmber of child added: '+contextObj.cart[x].childItems.length);
                    var childList       = contextObj.cart[x].childItems; 
                    var childQty        = childList.length; 
                    for(var y=0; y<childList.length; y++)
                    { 
                        if( childList[y].fields['catalogitemid'] == idChild)
                        {
                            console.log('*** found child *** --->'+childList[y].fields['productname']); 
                            var listOfAttr     = childList[y].listOfAttributes;
                    		var listOfFamilies = childList[y].listOfFamilies;
                    		var stringToAppend = '';
                            Visualforce.remoting.Manager.invokeAction 
				            (
				                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.retrieveFamilyNotHidden}',
				                idChild,
				                function(result,event)
				                { 
				                	if(result!=null && result!='')
				                	{ 
				                		stringToAppend += '<ul class="slds-has-dividers--bottom-space">';   
				                		for(var z=0; z<listOfAttr.length; z++ )
                                        {
                                            var idAttr   = listOfAttr[z].fields['idattr'];
                                            var idFamily = listOfAttr[z].fields['idfamily'];
                                            var attrName = listOfAttr[z].fields['name'];
                                            var readonly = listOfAttr[z].fields['readonly'];
                                            var req      = listOfAttr[z].fields['required'];
                                            var type     = listOfAttr[z].fields['type'];
                                            var value    = listOfAttr[z].fields['value'];

                                            stringToAppend += '<li id="AM_liChildAttr'+idAttr+'" class="slds-item">'; 
                                            if( req == 'Yes')
                                            {
                                                stringToAppend += '<div id="AM_childAttr'+idAttr+'"><abbr class="slds-required">*</abr>'+attrName+'</div>';
                                            }
                                            else
                                            {
                                                stringToAppend += '<div id="AM_childAttr'+idAttr+'">'+attrName+'</div>';
                                            }

                                            stringToAppend += '<div class="slds-form-element">';
                                            stringToAppend += '<div class="slds-form-element__control slds-grid">';

                                            if( type == 'String' )
                                            { 
                                                if(attrName.indexOf('mail')>0)
                                                {
                                                    console.log('Type input---email');
                                                    stringToAppend += '<input id="AM_email_'+idAttr+'" data-childId="'+idChild+'" class="slds-input" type="email" onblur="validateEmail(this.id)"/>'; 
                                                    stringToAppend += '<i id="AM_check_'+idAttr+'" class="fa fa-2x fa-check-circle" style="margin-left:2%"></i>';
                                                } 
                                                else
                                                {
                                                    stringToAppend += '<input id="AM_childAttr_'+idAttr+'" data-childId="'+idChild+'" class="slds-input" type="text" onblur="updateChildAttribute(this.id)"/>'; 
                                                }
                                            }
                                            else if( type=='Enumerated')
                                            {                                        
                                                console.log('Type picklist'); 
                                            }

                                            stringToAppend += '</div></div></li>';
                                        } 
                                    }  
		                            $('#AM_childAttrContent').append(stringToAppend);
		                            $("#AM_attributesContainer").addClass("slds-hide");
		                            $("#AM_childAttrContent").removeClass("slds-hide");
		                            $("#AM_prodSummary").empty();
		                            $("#AM_prodSummary").text('SUMMARY  ('+childQty+')');
		                            endLoading();
		                        }
		                    );
						}
					} 
				}
			}
        }

        function updateChildAttribute(inputId)
        {
        	console.log('*** updateChildAttribute ***'); 
        	startLoading();
        	var idAttr 			= inputId.substring(13,inputId.length);  
        	var attrValue 		= $('#'+inputId).val(); 
        	var mapOfAttr 		= {};
        	mapOfAttr[idAttr] = attrValue;
        	console.log(mapOfAttr); 
        	var idChild 		= $('#AM_childAttr_'+idAttr).data('childid'); 
        	var parentVid 		= $('#AM_categItem_'+idChild).data('fatheritemcode');
        	var childItemCode 	= $('#AM_categItem_'+idChild).data('itemcode'); 
        	console.log('***itemCode before the cart: '+childItemCode);
        	var lastContextObj = JSON.parse(lastContext);
        	console.log(lastContextObj.cart);
        	var childItemCodeInTheCart = '';
        	for(var x = 0; x<lastContextObj.cart.length; x++)
        	{
        		var childItems = lastContextObj.cart[x].childItems;
        		for(var y = 0 ; y<childItems.length; y++)
        		{
        			if(childItems[y].fields['catalogitemid'] == idChild)
        			{
        				console.log(childItems[y].fields['productname']);
        				console.log('***itemCode in the cart: '+childItems[y].fields['itemCode']);
        				childItemCodeInTheCart = childItems[y].fields['itemCode'];
        			}
        		}

        	} 

	    	Visualforce.remoting.Manager.invokeAction  
	  		(
	            '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.updateConfiguration}',
	            lastContext,
	            catalogId, 
	            mapOfAttr, 
	            childItemCodeInTheCart, 
	            parentVid, 
	            function(result,event)
	            { 
	            	lastContext = '';
	            	console.log(result);
	            	lastContext = JSON.stringify(result); 
	            	updateMessage(result);  
	            	endLoading();
	            }
	        );
      	}

        function updateChildAutoAdded(buttonId)
        {
        	console.log('*** updateChildAutoAdded ***');
        	var fatherId = $("#AM_extProduct").data("item"); 
        	var idChild = buttonId.substring(11,buttonId.length);  
            console.log(idChild);
            var lastContextObj = JSON.parse(lastContext);
            console.log(lastContextObj); 
            $('#AM_childAttrContent').empty();
			$('#AM_extChildProduct').empty(); 
			startLoading();
			buildChildAttributeForm(lastContextObj, fatherId, idChild);
        }

        $('.AM_click').click(function()
        {
            console.log('*** click ***');
            console.log(this); 
        });

        function changeAttribute()
        {
            console.log('*** UPDATE CONFIGURATION ***'); 
            
            var lastContextObj = JSON.parse(lastContext);
            console.log(lastContextObj);

            startLoading();

            //var cartContext = fatherCategoriesList[0].result.cart;
            //mt modified 12 gennaio 2017
            var cartContext = lastContextObj.cart;
            for(var x = 0; x<cartContext.length; x++)
            {
                var listOfAttr = cartContext[x].listOfAttributes;
                x = cartContext.length;
            }
            console.log('***listOfAttr***');
            console.log(listOfAttr);

            var IDs = $("#AM_attributesDiv div[id]").map(function(){ return this.id; }).get(); 
            var attrMap = {};
            console.log(IDs);   
            for(var i=0; i<IDs.length; i++)
            {
                //console.log(IDs[i]);
                var subId = IDs[i].substring(11,IDs[i].length);
                //console.log(subId); 
                var attrValue = $("#"+IDs[i]).next("div").children("div").children("div").children("select").find(":selected").text();
                //console.log('valore: '+attrValue);
                if(attrValue != '-----')
                    attrMap[subId] = attrValue;
                //mt modified 12 gennaio 2017
                else
                	attrMap[subId] = ''; 
            }  
            console.log('###attrMap      '+attrMap);
            //var catItem = fatherCategoriesList[0].catalogItemId; 
            //mtModified 12 gennaio 2017
            //updateConfiguration(fatherCategoriesList, attrMap); 
            updateFatherAttribute(attrMap); 
       }

       function updateFatherAttribute(attrMap)
       {
            console.log('### UPDATE CONFIGURATION Father ###');
            //console.log(fatherCategoriesList);
            console.log('mappa degli attributi');
            console.log(attrMap);
           
            //var catalogItem     = fatherCategoriesList[0].catalogItemId;
            //var catalogId       = fatherCategoriesList[0].catalogId;
            //var categoryId      = fatherCategoriesList[0].catId;
            //var vid             = fatherCategoriesList[0].faterVid;
            
            var categoryId = ''; //mt update 12 gennaio 2017//
            var parentvid = '';
            var vid = $('#AM_extProduct').data('parentitemcode');
			console.log('VID:'+vid); 
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.updateConfiguration}', 
                lastContext,
                catalogId, 
                attrMap,
                vid,
                parentvid,
                function(result,event)
                { 
                    lastContext = '';
                    console.log('Result of update attribute');
                    console.log(result);
                    lastContext = JSON.stringify(result);  
                    Visualforce.remoting.Manager.invokeAction
                    (   
                        '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.retrieveComplex}',
                         orderId,
                         catalogId,
                         categoryId,
                         lastContext,  
                         vid,
                         function(result,event)
                         { 
                            lastContext = '';
                            console.log('Result of complex retieve');
                            console.log(result);
                            lastContext = JSON.stringify(result); 
                            updateMessage(result); 
                            endLoading();
                         }
                    );
                } 
            );        
       }
       function abortConfiguration()
       {
       		console.log('*** abort configuration ***');
            console.log(lastContext);
            if(typeof lastContext === 'string')
            {
                lastContextStr = lastContext;
            }
            else
            {
                lastContextStr = JSON.stringify(lastContext);
            } 
            startLoading();
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.abortConfiguration}',
                catalogId,
                lastContextStr,
                function(event,result)
                {
                	console.log('*** result ***');
                	lastContext = '';
                    console.log(result);
                    lastContext = JSON.stringify(result); 
                	endLoading();
	                reLoadPage(); 
                }
            );
       }
       function saveConfiguration()
       { 
            console.log('*** save configuration ***');
            console.log(JSON.parse(lastContext)); 

            if(typeof lastContext === 'string')
            {
                lastContextStr = lastContext;
            }
            else
            {
                lastContextStr = JSON.stringify(lastContext);
            }  
            var currentProdCategory = $('#AM_extProduct').data('category');
            console.log(currentProdCategory);
			var configurationStatus = $('#AM_esitoStatus').children('strong').get(0).textContent;
            console.log('#AM_esitoStatus');
            console.log(configurationStatus); 
            startLoading();
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.saveConfiguration}',
                catalogId,
                currentProdCategory,
                lastContextStr,
                function(result,event)
                { 
                    lastContext = '';
                    console.log(result);
                    lastContext = JSON.stringify(result); 
                    $('#AM_cartMsg').css('display','none');
                    endLoading();
                    reLoadPage(); 
                }
            );
       }

       var counterServices = 0; 

        function configureChildItem(childItemId)
        {
            console.log('*** CONFIGURE CHILD ITEM ***  '+childItemId); 
            var childId = childItemId.substring(13, childItemId.length); 
            var childItemName = $('#'+childItemId).data("productname");
            var childItemCategory = $('#'+childItemId).data("categoryid");
            
            // console.log('*** fatherCategoriesList***');
            // console.log(fatherCategoriesList);
            // console.log('*** last context ***'); 

            var prova = JSON.parse(lastContext);
            console.log (prova);

            $('#'+childItemId).addClass('AM_selected');
 
            var catalogid = '{!catalogId}';
            var categoryid = $("#AM_categItem_"+childId).data('categoryid'); 
            var qty = '1'; 
            var parentItemdCode = $("#AM_categItem_"+childId).data('parentvid'); 
            var parentvid = $("#AM_categItem_"+childId).data('fatheritemcode');

            var rootVid = $("#AM_categItem_"+childId).data('rootvid');

            startLoading(); 
            $("#AM_configurationProd").removeClass("AM_backgroundGrey"); 
            //$("#AM_configurationChildProd").removeClass("AM_backgroundGrey").addClass("AM_selected"); 
            //$("#AM_configurationChildProd").empty();
            // var childStr = '';
            // for(var x = 0; x<prova.listOfItems.length; x++)
            // {
            //  if(prova.listOfItems[x].fields['catalogitemid'] == childId)
            //  {
            //      console.log('nome '+prova.listOfItems[x].fields['productname']);
            //      childStr = '<h2 id="AM_extChildProduct" class="slds-p-around--small slds-align--absolute-center">'+prova.listOfItems[x].fields['productname']+'</h2>';
            //  }   
            // } 
             

            var fatherId = $("#AM_extProduct").data("item");

            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.upsertChildItems}',
                 catalogid,
                 categoryid,  
                 childId, 
                 lastContext,
                 qty,
                 parentvid,
                 function(result,event)
                 {
                    lastContext = '';
                    console.log(result); 
                    lastContext = JSON.stringify(result);  
                    lastContext = result;  
                    console.log('lastContext.cart');
                    console.log(lastContext.cart);
                    var stringToAppend = '';
                    stringToAppend += '<ul class="slds-has-dividers--bottom-space">';
                    for(var x=0; x<lastContext.cart.length; x++)
                    {
                        console.log('fatherId'+fatherId);
                        console.log('cartfields'+lastContext.cart[x].fields['catalogitemid']);
                        if(lastContext.cart[x].fields['catalogitemid'] == fatherId)
                        {
                            console.log('trovato il padre');
                            console.log('lista figli aggiunti(size): '+lastContext.cart[x].childItems.length);
                            console.log(lastContext.cart[x].childItems);
                            var childItemList = lastContext.cart[x].childItems;
                            for(var y=0; y<childItemList.length; y++)
                            {
                                if(childItemList[y].fields['catalogitemid'] == childId)
                                {
                                    console.log('trovato il figlio--> '+childItemList[y].fields['productname'])
                                    var listOfAttr      = childItemList[y].listOfAttributes;
                                    var listOfFamilies  = childItemList[y].listOfFamilies; 

                                    var baseonetimefee = childItemList[y].fields['baseonetimefee'];
                                    var baserecurringcharge = childItemList[y].fields['baserecurringcharge']; 

                                    if( listOfFamilies>0 )
                                    {
                                        console.log('lista famiglie del figlio è maggiore di zero');
                                        console.log('lista attributi del figlio');
                                        console.log(listOfAttr);
                                        for(var z=0; z<listOfAttr.length; z++ )
                                        {
                                            var idAttr   = listOfAttr[z].fields['idattr'];
                                            var idFamily = listOfAttr[z].fields['idfamily'];
                                            var attrName = listOfAttr[z].fields['name'];
                                            var req      = listOfAttr[z].fields['required'];
                                            var type     = listOfAttr[z].fields['type'];
                                            var value    = listOfAttr[z].fields['value'];

                                            stringToAppend += '<li id="AM_liChildAttr'+idAttr+'" class="slds-item">'; 
                                            if( req == 'Yes')
                                            {
                                                stringToAppend += '<div id="AM_childAttr'+idAttr+'"><abbr class="slds-required">*</abr>'+attrName+'</div>';
                                            }
                                            else
                                            {
                                                stringToAppend += '<div id="AM_childAttr'+idAttr+'">'+attrName+'</div>';
                                            }

                                            stringToAppend += '<div class="slds-form-element">';
                                            stringToAppend += '<div class="slds-form-element__control">';

                                            if( type=='String' )
                                            {
                                                console.log('Type input');
                                                stringToAppend += '<input class="slds-input" type="text"/>';
                                            }
                                            else if( type=='Enumerated')
                                            {                                        
                                                console.log('Type picklist');
                                                //stringToAppend += '<div class="slds-select_container"><select class="slds-select" onchange="changeAttribute()"><option>-----</option>';
                                            }

                                            stringToAppend += '</div></div></li>';
                                        }
                                    } 
                                    stringToAppend += '</ul>';
                                    $('#AM_childAttrContent').append(stringToAppend).addClass('AM_selected');
                                }
                            }
                        }
                    }

                    //$("#AM_configurationChildProd").append(childStr); 
                    $("#AM_attributesContainer").addClass('slds-hide');
                    $("#AM_childAttrContent").removeClass('slds-hide'); 
                    endLoading();
                }
            );  
        } 

        function validateEmail(mailId)
        {
            var attrId = mailId.substring(9,mailId.length);   
            var email = $('#AM_email_'+attrId).val(); 
            var childId 	= $('#'+mailId).data('childid'); //catalogItemId of the child 
            var parentvid 	= $("#AM_categItem_"+childId).data('fatheritemcode'); 
			var childItemCodeInTheCart = '';
            var lastContextObj = JSON.parse(lastContext);
        	console.log(lastContextObj.cart); 

        	for(var x = 0; x<lastContextObj.cart.length; x++)
        	{
        		var childItems = lastContextObj.cart[x].childItems;
        		for(var y = 0 ; y<childItems.length; y++)
        		{
        			if(childItems[y].fields['catalogitemid'] == childId)
        			{
        				console.log(childItems[y].fields['productname']);
        				console.log('***itemCode in the cart: '+childItems[y].fields['itemCode']);
        				childItemCodeInTheCart = childItems[y].fields['itemCode'];
        			}
        		} 
        	} 

            if( $('#AM_check_'+attrId).hasClass('AM_colorGreen') )
            {
                console.log('****  posso fare update dellattributo *****');
                var inputValue = $('#AM_email_'+attrId).val();
                console.log(inputValue);
                var attrMap = {};
                attrMap[attrId] = inputValue;
                console.log('*** attrMap ***');
                console.log(attrMap); 
                startLoading();
                Visualforce.remoting.Manager.invokeAction
                ( 
                    '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.updateConfiguration}', 
                    lastContext,
                    catalogId,
                    attrMap,
                    childItemCodeInTheCart,
                    parentvid,
                    function(result,event)
                    {
	                    lastContext = '';
	                    console.log('*** Result of update attribute ***');
	                    console.log(result); 
	                    console.log('***parentvid: '+parentvid);
	                    console.log('***childItemCodeInTheCart: '+childItemCodeInTheCart);
	                    for(var n = 0; n<result.cart.length; n++)
	                    { 
	                    	 if(result.cart[n].fields['itemCode'] == parentvid)
	                    	 {
	                    	 	console.log('trovato il padre  '+result.cart[n].fields['productname']);
	                    	 	for(var m = 0; m<result.cart[n].childItems.length; m++)
	                    	 	{
	                    	 		if(result.cart[n].childItems[m].fields['itemCode'] == childItemCodeInTheCart)
	                    	 		{
	                    	 			console.log('trovato il figlio  '+result.cart[n].childItems[m].fields['productname']);
	                    	 			console.log('lista attributi');
	                    	 			console.log(result.cart[n].childItems[m].listOfAttributes);
	                    	 			for(var k = 0; k<result.cart[n].childItems[m].listOfAttributes.length; k++)
	                    	 		 	{
	                    	 		 		if(result.cart[n].childItems[m].listOfAttributes[k].fields['idattr']==attrId)
	                    	 		 		{
	                    	 		 			console.log('nome attributo: '+result.cart[n].childItems[m].listOfAttributes[k].fields['name']);
	                    	 		 			//console.log('validationmessage: '+result.cart[n].childItems[m].listOfAttributes[k].fields['validationmessage']);
	                    	 		 			console.log('validated: '		 +result.cart[n].childItems[m].listOfAttributes[k].fields['validated']);
	                    	 		 			if(result.cart[n].childItems[m].listOfAttributes[k].fields['validated'] == true)
	                    	 		 			{
	                    	 		 				$('#AM_check_'+attrId).removeClass('slds-hidden'); 
                									$('#AM_stop_'+attrId).addClass('slds-hidden'); 
	                    	 		 			}
	                    	 		 			else
	                    	 		 			{
	                    	 		 				$('#AM_stop_'+attrId).removeClass('slds-hidden'); 
                									$('#AM_check_'+attrId).addClass('slds-hidden'); 
	                    	 		 			}
	                    	 		 		}
	                    	 		 	}
	                    	 		}
	                    	 	}
	                    	 }
	                    } 
	                    var status = result.configuration.NE__ConfigurationStatus__c; 
	                    var messageList = result.messages;
	                    lastContext = JSON.stringify(result); 
	                    updateMessage(result);
	                    endLoading();
                    }
                );  
            } 
        } 

        function validateCellularNumber(cellId)
        {
            var cellId = cellId.substring(8,cellId.length);  
            console.log(cellId);
            var cell = $('#AM_email_'+cellId).val();
            console.log('***valore inserito per cell: '+cell);
            var cellNumbRegex = /^([+]39)?((38[{8,9}|0])|(34[{7-9}|0])|(36[6|8|0])|(33[{3-9}|0])|(32[{8,9}]))([\d]{7})$/;
            //pass +393471234567|||3381234567
            console.log(cellNumbRegex.test(cell));
            if( cellNumbRegex.test(cell) == true)
            {
                $('#AM_check_'+attrId).removeClass('AM_colorRed').addClass('AM_colorGreen');
                $('#AM_check_'+attrId).removeClass('fa-times-circle').addClass('fa-check-circle');
            }
            else
            {
                $('#AM_check_'+attrId).removeClass('AM_colorGreen').addClass('AM_colorRed');
                $('#AM_check_'+attrId).removeClass('fa-check-circle').addClass('fa-times-circle');
            }
           
            
        }

        function removeItemFormSummaryCart(catalogItemId)  
        {
            console.log('*** REMOVE SINGLE ITEM FUCNTION ***');
            startLoading();

            console.log('*** addedProducts (prima) ***'); 
            console.log(addedProducts);
            var catalogItemToRemove = catalogItemId.substring(17,catalogItemId.length); 
            for(var x=0; x<addedProducts.length; x++)
            {
                if(addedProducts[x].fields['catalogitemid'] == catalogItemToRemove)
                {
                    addedProducts.remove(addedProducts[x]);
                }
            }
            console.log('*** addedProducts (dopo) ***');
            console.log(addedProducts); 
            
            
            var categoryId = $("#"+catalogItemId).data("category");
            var catalogId = '{!catalogId}'; 
            Visualforce.remoting.Manager.invokeAction 
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.removeItems}',  
                 catalogId,   
                 catalogItemToRemove,
                 lastContext,  
                 function(result, event)
                 { 
                    lastContext = ''; 
                    console.log(result);
                    var cartQty = result.cart.length;
                    var configuration = result.configuration.NE__ConfigurationStatus__c;
                    console.log('configurationStatus: '+configuration);
                    console.log('***sezione messaggi= '+ result.messages.length);
                    console.log('+++ cartQty : '+cartQty);
                    lastContext = JSON.stringify(result);  
                    buildSummary(configuration);
                    // if(result.messages == null && result.messages.lenght == 0)
                    // {
                    //     console.log('### cartella messaggi vuota ###');
                    //     $('#AM_cartMsg').empty().addClass('slds-hide');   
                    // }
                    // else
                    // {
                    // 	console.log('### cartella messaggi NON vuota ###'); 

                    // } 
                     
                    $("#AM_liSummary_"+catalogItemToRemove).remove();
                    if( cartQty == 0 )
                    {
                        $('#AM_summarySection').css('display', 'none');
                        $('#AM_prodInCart').text('(0)');
                    }
                    else
                    {
                        $('#AM_prodInCart').text('('+cartQty+')');
                    }


                    endLoading();
                 }
            );
        }
        
        function resetCart()
        {
            console.log('*** resetcart ***'); 
            var catalogId = '{!catalogId}'; 
            startLoading();
            Visualforce.remoting.Manager.invokeAction 
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.clearCart}',  
                catalogId,
                lastContext,  
                function(result, event)
                {
                    lastContext = '';
                    console.log(result);
                    lastContext = JSON.stringify(result);

                    if(result.messages == null && result.messages.lenght == 0)
                    {
                        $('#AM_cartMsg').empty();
                    } 
                    addedProducts = [];
                    product = new Object();
                    fields = new Object();
                    addedProductsToString = '';
                    $('#AM_cartSummary').empty();
                    $('#AM_summarySection').addClass('AM_dispNone');
                    $('#AM_prodInCart').text('(0)');
                    addedProducts = [];
                    endLoading();
                }
            );
        }

        function checkOut()
        {  
            console.log('*** CHECK OUT FUCNTION ***');  
            console.log(lastContext);
            console.log('TYPE Of context ');
            console.log(typeof lastContext);
            var lastContextStr;
            if(typeof lastContext === 'string')
            {
                lastContextStr = lastContext;
            }
            else
            {
                lastContextStr = JSON.stringify(lastContext);
            }
            
            var ordId = '{!ordId}'; 
            var catalogId = '{!catalogId}';
            console.log('*** catalog id :'+catalogId);
            if( ordId != '' || ordId != null)
            {
                startLoading();
                Visualforce.remoting.Manager.invokeAction
                ( 
                    '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.checkOutCart}', 
                    ordId, 
                    catalogId,
                    lastContextStr, 
                    function(result,event)
                    {  
                        console.log("ORDINE AGGIORNATO CON ORDER ITEM!!!----> ID DELL'ORDINE : "+ordId);
                        console.log(result); 
                        //setRecordTypeOrderItem(ordId); 
                        createQuote();
                    }
                )
            }

        } 

        // function setRecordTypeOrderItem(ordId)
        // {
        //     console.log('*** SET RECORD TYPE ID of ORDER ITEMS ***');
        //     Visualforce.remoting.Manager.invokeAction
        //     ( 
        //         '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.setRecordTtpeOrderItem}', 
        //         ordId, 
        //         function(result,event)
        //         { 
        //             console.log("FINE SET RECORD TYPE");
        //             console.log(result);
        //             createQuote();
        //         }
        //     )
        // }

        var quoteId = '';
        function createQuote()
        {
            var ordId = '{!ordId}'; 
            var quoteRT = ''; 
            Visualforce.remoting.Manager.invokeAction
            ( 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.getRTQuote}', 
                ordId,
                function(result,event)
                { 
                    quoteRT = result;
                    console.log('quote record type -->'+quoteRT);
                    if( quoteRT != null) 
                    {
                        //alert('*** record type quote = '+quoteRT+' ***');
                        Visualforce.remoting.Manager.invokeAction
                        ( 
                            '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.createNewQuote}', 
                            ordId,
                            quoteRT,
                            category,
                            function(result,event)
                            { 
                                quoteId = result;
                                alert('*** QUOTE CREATA E ASSOCIATA --> id = '+quoteId+' ***');
                                redirectToPage(quoteId);
                            }
                        );
                    }
                    else
                    	alert('*** record type quote = '+quoteRT+' ***');
                }
            );

        }




        var checkOutPermission = true; 
        
        /****************************************************************************************/
        /*                                  COUNTER FUCNTION                                    */
        /****************************************************************************************/

        function minus(catItemId)
        {       
            console.log('*** minus ***');
            console.log(catItemId);
            var catalogItem = catItemId.substring(9,catItemId.length);
            console.log(catalogItem);
            var inputVal = $('#AM_inputQty_'+catalogItem).val();
            console.log('valore = '+inputVal); 
            if(inputVal > 0)
            {
                inputVal--;
                $('#AM_inputQty_'+catalogItem).val(inputVal);
            }

        }

        function plus(catItemId)
        {
            console.log('*** plus ***');
            console.log(catItemId);
            var catalogItem = catItemId.substring(8,catItemId.length);
            console.log(catalogItem);
            var inputVal = $('#AM_inputQty_'+catalogItem).val();
            console.log('valore = '+inputVal); 
            inputVal++;
            $('#AM_inputQty_'+catalogItem).val(inputVal); 
        }
        /****************************************************************************************/
        
 
        
        function test(param){
            //alert('*** param:'+param);
            //alert('** jQuery:'+$('#myParam').val());
            redirectToPage(param);
        }
        /*********************************************** SPINNER FUNCTION **************************************************/
        function startLoading()
        {
            console.log('*** startLoading***');
            $('#AM_spinner').removeClass('slds-hide');
        }
        function endLoading()
        {
            console.log('*** endLoading ***');
            $('#AM_spinner').addClass('slds-hide');
        }
        /*******************************************************************************************************************/
        
        /**********************************************************************/ 
        /*                           CART SECTION                             */ 
        /**********************************************************************/
        /* Open cart Summary: method that open the summary section on the right side of the page*/
        function openCartSummary()
        {
            console.log('*** OPEN CART SUMMARY*** ---> '+$('#AM_prodInCart').text());  
            if( $('#AM_prodInCart').text() != '(0)' )
            { 
                if( $('#AM_summarySection').hasClass("slds-hide") || $('#AM_summarySection').hasClass("AM_dispNone"))
                {
                    $('#AM_summarySection').slideToggle(600);  
                    $('#AM_summarySection').removeClass("AM_dispNone");   
                }
                else  
                {
                    $('#AM_summarySection').slideToggle(600);  
                } 
            } 
        }  

        function openEnvelopeMessages()
        {
            console.log('*** OPEN ENVELOPE MESSAGES ***');  
            if( $('#AM_envelopeMsg').text() != '  (0)  ' )
            { 
                if( $('#AM_envelopeMsg_section').hasClass("slds-hide"))
                { 
                    $('#AM_envelopeMsg_section').removeClass("slds-hide");  
                }
                else  
                {
                    $('#AM_envelopeMsg_section').slideToggle(600);  
                } 
            } 
            else
            {
				console.log('*** OPEN ENVELOPE MESSAGES emty ***');  
            }
        }

        function backToHome()
        {

        }

        function closeAlert()
        {
            $("#AM_alert").removeClass("slds-fade-in-open"); 
            $("#AM_alertQty").removeClass("slds-fade-in-open");
            $("#AM_alertSummary").removeClass("slds-fade-in-open");

            $("#AM_alert_backdrop").removeClass("slds-backdrop--open"); 
            $("#AM_alert_backdrop_qty").removeClass("slds-backdrop--open");  
            $("#AM_alert_backdrop_summary").removeClass("slds-fade-in-open");  

        }
 
        /*******************************************************************************************************************/
       function openConfigurationTab()
       {
            $("#AM_itemOne").addClass("slds-active");
            $("#AM_itemTwo").removeClass("slds-active");
            $('#tab-scoped-2').removeClass('slds-show').addClass('slds-hide');
            $('#tab-scoped-1').removeClass('slds-hide').addClass('slds-show'); 
       }

       function openSummary()
       {
            console.log('*** OPEN SUMMARY ***'); 

            if( $('#AM_prodSummary').text() != 'SUMMARY  (0)')
            {
            	$("#AM_itemTwo").addClass("slds-active");
	            $("#AM_itemOne").removeClass("slds-active");

	            var lastContextObj = JSON.parse(lastContext);
	            console.log(lastContextObj);
	            var catalogItemFatherId = $('#AM_extProduct').data('item');
	            var fatherProductName = $('#AM_extProduct').text();
	            $('#tab-scoped-1').removeClass('slds-show').addClass('slds-hide');
	            $('#tab-scoped-2').removeClass('slds-hide').addClass('slds-show');

	  
	            $('#AM_summaryContainer').empty();
	            var stringToAdd = '';

	            var imgSrc = $('#AM_configurationProd').children('div').children('img').attr('src');

	            var imgStr = '<img class="AM_thumbnailSummary slds-icon slds-icon--medium slds-icon_container" src="'+imgSrc +'"/>';  
	            
	            stringToAdd += '<article class="slds-card">'; 
	            stringToAdd += '<div class="slds-grid slds-medium-size--6-of-6 slds-large-size--12-of-12">'; 
	            stringToAdd += imgStr+'<h2 id="AM_summaryTitle" data-catalogitemfatherid="'+catalogItemFatherId+'" class="AM_summaryTitle slds-p-around--small slds-text-heading--medium">'+fatherProductName+'</h2>'; 
	            stringToAdd += '</div>';
	            stringToAdd += '<div class="slds-card__body">';
	            stringToAdd += '<table class="slds-table slds-table--bordered slds-no-row-hover slds-table--cell-buffer">'; 
	            stringToAdd += '<thead>';
	            stringToAdd += '<tr class="slds-text-title--caps">';
	            stringToAdd += '<th scope="col" style="width:730px"><div class="slds-truncate">{!$Label.ITA_IFM_AM_ProductName}</div></th>';
	            stringToAdd += '<th scope="col"><div style="margin-left:15%">{!$Label.ITA_IFM_AM_Qty}</div></th>'; 
	             stringToAdd += '<th scope="col"><div style="margin-left:35%">{!$Label.ITA_IFM_AM_Update}</div></th>';
	            stringToAdd += '<th scope="col"><div style="margin-left:35%">{!$Label.ITA_IFM_AM_Remove}</div></th>';
	            stringToAdd += '</tr></thead></table>';
	            
	            stringToAdd += '<div style="overflow-y:scroll; max-height:200px;"><tbody>'; 
	            stringToAdd += '<table class="slds-table slds-table--bordered slds-table--col-bordered slds-no-row-hover slds-table--cell-buffer">';
	            for(var x = 0; x< lastContextObj.cart.length; x++)
	            {
	                if(catalogItemFatherId == lastContextObj.cart[x].fields['catalogitemid'])
	                {
	                    var fatherQty = lastContextObj.cart[x].fields['qty'];
	                    var listOfchildItems = lastContextObj.cart[x].childItems;
	                    console.log('*** listOfchildItems***');
	                    console.log(listOfchildItems);
	                    for( var i = 0; i<listOfchildItems.length; i++)
	                    {
	                        var childName 	= listOfchildItems[i].fields['productname'];
	                        var childId 	= listOfchildItems[i].fields['catalogitemid'];
	                        var childQty 	= listOfchildItems[i].fields['qty'];
	                        var minQty 		= listOfchildItems[i].fields['minqty'];
	                        var maxQty 		= listOfchildItems[i].fields['maxqty'];
	                        //var pickedby 		= listOfchildItems[i].fields['pickedby'];  //pickedby is to manage bundle product but not work  
	                          

	                        stringToAdd += '<tr>';
	                        stringToAdd += '<td style="width:712px"><div class="slds-grid">';
	                        stringToAdd += '<button id="'+childId+'" class="slds-button" onClick="opendOrderItemAttr(this.id)">';
	                        stringToAdd += '<i class="fa fa-2x fa-search-plus slds-icon slds-con--small"></i></button>';
	                        stringToAdd += '<div class="slds-truncate" style="margin-left: 5%;">'+childName+'</div></div>';

	                        var listOfChildAttr = listOfchildItems[i].listOfAttributes;
	                        if(listOfChildAttr.length > 0)
	                        {  
	                            stringToAdd += '<div id="AM_attrChildName_'+childId+'" class="slds-grid slds-hide">';
	                            stringToAdd += '<table class="AM_childAttrTable slds-table slds-table--bordered slds-table--cell-buffer slds-table--col-bordered">';  
	                            stringToAdd += '<thead style="background-color:#f4f6f9!important;">'
	                            stringToAdd += '<tr class="slds-text-title--caps">';
	                            stringToAdd += '<th scope="col"><div class="slds-truncate">{!$Label.ITA_IFM_AM_AttributesOf}   '+childName+'</div></th>';
	                            stringToAdd += '<th scope="col"><div class="slds-truncate">{!$Label.ITA_IFM_AM_Value}</div></th>';
	                            stringToAdd += '</tr></thead>';  
	                            stringToAdd += '<tbody>';
	                            for(var n = 0; n<listOfChildAttr.length; n++)
	                            {
	                                var attrName = listOfChildAttr[n].fields['name'];
	                                var attrValue = listOfChildAttr[n].fields['value']; 
	                                stringToAdd += '<tr>';
	                                stringToAdd += '<td><div class="slds-truncate">'+attrName+'</div></td>';
	                                stringToAdd += '<td><div class="slds-truncate">'+attrValue+'</div></td>';
	                                stringToAdd += '</tr>';
	                            }
	                            stringToAdd += '</tbody></table></div></div></td>'; 
	                        }
	                        stringToAdd += '<td class="slds-align-top" style="width:100px;"><div>'+childQty+'</div></td>';    
	                        stringToAdd += '<td class="slds-align-top" style="width:100px;"><div>';
	                        stringToAdd += '<button id="AM_updateChild_'+childId+'" class="slds-button">';
            				stringToAdd += '<i class="fa fa-2x fa-wrench slds-icon slds-con--small"></i></button>'; 
	                        stringToAdd += '</div></td>';   
	                         
	                        stringToAdd += '<td class="slds-align-top slds-cell-shrink">'; 
	                        if(minQty == 1 && maxQty == 1)//bundle product !?! 
	            			{
	            				console.log('###childName:'+childName+'    ####minqty: '+minQty+'    ###maxqty: '+maxQty )
	            				stringToAdd += '<button id="AM_removeChild_'+childId+'" class="slds-button">';
	            				stringToAdd += '<i class="fa fa-2x fa-ban slds-icon slds-con--small"></i></button>'; 
	            			}
	            			else
	            			{
	            				console.log('###childName:'+childName+'    ####minqty: '+minQty+'    ###maxqty: '+maxQty )
	            				stringToAdd += '<button id="AM_removeChild_'+childId+'" class="slds-button" onClick="removeChildItems(this.id)">';
	            				stringToAdd += '<i class="fa fa-2x fa-trash slds-icon slds-con--small"></i></button>'; 
	            			}
	                        stringToAdd += '</td></tr>';
	                    }
	                }
	            }

	            stringToAdd += '</tbody></table></article>';
	            $('#AM_summaryContainer').append(stringToAdd);
	        }
	        else
	        {
	        	$('#AM_alertSummary').addClass('slds-fade-in-open');
	        	$('#AM_alert_backdrop_summary').addClass('slds-fade-in-open');
	        }	        	
       }

       function removeChildItems(buttonId)
       {
       		console.log('@Remove child'); 
       		var childId = buttonId.substring(15,buttonId.length);
       		console.log(childId);
       		console.log(lastContext);
       		startLoading(); 
       		Visualforce.remoting.Manager.invokeAction
            (				 
                '{!$RemoteAction.ITA_IFM_VFC059_AM_Cart.removeItems}', 
                catalogId, 
                childId,
                lastContext,
                function(result,event)
                { 
                	console.log(result); 
                	lastContext = '';   
                    lastContext = JSON.stringify(result); 
                	if (event.status) 
                	{
                		$('#AM_attrChildName_'+childId).parent().parent().remove();
                		console.log($('#AM_prodSummary').text()); 
                		var text = $('#AM_prodSummary').text();
                		var childItemsAdded = text.match(/\d+/);    
                		var before = childItemsAdded[0]; 
                		var after = --before; 
                		var newText = 'SUMMARY  ('+after+')';
                		$('#AM_prodSummary').empty().text(newText);
                		 
                	}
                	else if (event.type === 'exception') 
                	{
                		document.getElementById("responseErrors").innerHTML = event.message;
					} 
					else 
					{ 
						document.getElementById("responseErrors").innerHTML = event.message;
					} 
					endLoading();
                }
       		);
       }

       function opendOrderItemAttr(childId)
       {
       		console.log(childId);
       		if( $("#AM_attrChildName_"+childId).hasClass("slds-hide") )
       		{
       			$("#AM_attrChildName_"+childId).removeClass("slds-hide");
				$("#"+childId).children('i').addClass("fa-search-minus").removeClass("fa-search-plus");  
       		}
       		else
       		{
       			$("#AM_attrChildName_"+childId).addClass("slds-hide");
 				$("#"+childId).children('i').addClass("fa-search-plus").removeClass("fa-search-minus"); 
       		}
            
       }
    </script> 
<!-- ####################################################################################################################################################### --> 
<!--                                                                       HTML                                                                              -->
<!-- ####################################################################################################################################################### -->     
	<div id="AM_container" class="ITA_IFM_AppMobile">
    
	    <!-- ######################################################### --> 
	    <!--                          SPINNER                          -->   
	    <!-- ######################################################### -->  
	    <div id="AM_spinner" class="slds-spinner_container slds-hide">
	    	<div class="slds-grid" style="height: 80%;">
	            <span id='AM_load-msg-id' class="slds-align--absolute-center slds-text-heading--large slds-text-color--weak">
	                <b><label id="AM_load-msg-label-id">{!$Label.NE__loading}</label></b>
	            </span>
	        </div>
	        <div class="slds-grid">
	            <div class="slds-spinner slds-spinner--large" role="alert">
	                <div class="slds-spinner__dot-a"></div>
	                <div class="slds-spinner__dot-b"></div>
	            </div>
	        </div> 
	    </div>  
	    <!-- ######################################################### --> 
	    <!--                         ALERT MODAL                       -->   
	    <!-- ######################################################### -->    
	    <div id="AM_alert" role="dialog" tabindex="-1" class="slds-modal">
	        <div class="slds-modal__container AM_alertContainer">
	            <div class="slds-modal__header slds-theme--error slds-theme--alert-texture">
	                <button class="slds-button slds-modal__close slds-button--icon-inverse" title="Close" onClick="closeAlert();">
	                    <img class="slds-icon" src="{!URLFOR($Resource.NELightningResource, '/assets/icons/utility/close_60.png')}"/>
	                </button>
	                <h2 id="header43" class="slds-text-heading--medium">{!$Label.ITA_IFM_AM_Warning}</h2>     
	            </div>

	            <div id="AM_alertCommodityType" class="slds-modal__content slds-p-around--medium slds-hide">
	                <div>
	                    <p class="slds-text-align--center">{!$Label.ITA_IFM_AM_ProdCompatibility}</p>
	                </div>     
	            </div>
	            <div id="AM_alertProductTypology" class="slds-modal__content slds-p-around--medium slds-hide">
	                <div>
	                    <p class="slds-text-align--center">{!$Label.ITA_IFM_AM_TypologyProductCompatibility}</p>
	                </div>     
	            </div>
	        </div> 
	    </div> 
	    <div id="AM_alert_backdrop" class="slds-backdrop"></div>
	    <!-- ######################################################### --> 
	    <!--                         ALERT QUANTITY                    -->   
	    <!-- ######################################################### -->    
	    <div id="AM_alertQty" role="dialog" tabindex="-1" class="slds-modal">
	        <div class="slds-modal__container AM_alertContainer">
	            <div class="slds-modal__header slds-theme--error slds-theme--alert-texture">
	                <button class="slds-button slds-modal__close slds-button--icon-inverse" title="Close" onClick="closeAlert();">
	                    <img class="slds-icon" src="{!URLFOR($Resource.NELightningResource, '/assets/icons/utility/close_60.png')}"/>
	                </button>
	                <h2 id="header43" class="slds-text-heading--medium">{!$Label.ITA_IFM_AM_Warning}</h2>     
	            </div>

	            <div class="slds-modal__content slds-p-around--medium">
	                <div>
	                    <p class="slds-text-align--center">{!$Label.ITA_IFM_AM_InsertQty}</p>
	                </div>     
	            </div>
	        </div> 
	    </div> 
	    <div id="AM_alert_backdrop_qty" class="slds-backdrop"></div>
	    <!-- ######################################################### --> 
	    <!--                         ALERT SUMMARY                     -->   
	    <!-- ######################################################### -->    
	    <div id="AM_alertSummary" role="dialog" tabindex="-1" class="slds-modal">
	        <div class="slds-modal__container AM_alertContainer">
	            <div class="slds-modal__header slds-theme--error slds-theme--alert-texture">
	                <button class="slds-button slds-modal__close slds-button--icon-inverse" title="Close" onClick="closeAlert();">
	                    <img class="slds-icon" src="{!URLFOR($Resource.NELightningResource, '/assets/icons/utility/close_60.png')}"/>
	                </button>
	                <h2 id="header43" class="slds-text-heading--medium">{!$Label.ITA_IFM_AM_Warning}</h2>     
	            </div>

	            <div class="slds-modal__content slds-p-around--medium">
	                <div>
	                    <p class="slds-text-align--center">{!$Label.ITA_IFM_AM_NoChildProdAdded}</p>
	                </div>     
	            </div>
	        </div> 
	    </div> 
	    <div id="AM_alert_backdrop_summary" class="slds-backdrop"></div>
	    <!-- ######################################################### --> 
	    <!--                           LOGO                            -->   
	    <!-- ######################################################### -->    
		<div class="slds-size--1-of-1 slds-grid">       
            <div class="slds-size--1-of-3">
                <img class="AMlogo slds-m-left--x-large" onclick="backToHome(); return false;" src="/resource/1479442272000/ITA_IFM_AppMobile_images/img/enel_logo.png"/>
            </div> 
        </div>
        <div class="slds-size--1-of-1 slds-size--1-of-1 slds-m-top--small slds-align--absolute-center" id="rowTableIcon"> 
            <div class="slds-grid slds-size--1-of-1" id="AMdivcolors">
                <div class="slds-col" id="divcolor1"></div>
                <div class="slds-col" id="divcolor2"></div>
                <div class="slds-col" id="divcolor3"></div>
                <div class="slds-col" id="divcolor4"></div>
            </div>
        </div> 
        <!-- ######################################################### --> 
	    <!--                          NAV BAR                          -->   
	    <!-- ######################################################### --> 
        <div id="AM_header" class="slds-grid">  
            <div class="slds-page-header slds-p-horizontal--small  slds-align--absolute-center slds-size--1-of-1  slds-medium-size--6-of-6 slds-large-size--12-of-12" role="banner">        
                <div class="slds-tabs--path" role="application">                         
                   <ul id="AM_bar" class="slds-tabs--path__nav" role="tablist">
                      <button id="AM_catalog" class="slds-button slds-button--brand slds-no-flex slds-m-horizontal--small" onClick="reLoadPage()">
                            {!$Label.ITA_IFM_AM_Showcase}
                      </button>                      
                      <li id="AM_li_1" class="slds-hidden slds-tabs--path__item slds-is-current AM_LiBorderRound_Left" role="presentation" onClick="goBack()">
                        <a class="slds-tabs--path__link" id="tabs-path-421" aria-controls="content-path-1" aria-selected="false" tabindex="-1" role="tab" href="javascript:void(0);" aria-live="assertive">
                            <span class="slds-tabs--path__stage AM_categToAppend1"></span>  
                            <span  class="slds-tabs--path__title AM_categToAppend1"></span>
                        </a>
                      </li>   
                      <li id="AM_li_2" class="slds-hidden slds-tabs--path__item AM_LiBorderRound" role="presentation">
                        <a class="slds-tabs--path__link" id="tabs-path-421" aria-controls="content-path-1" aria-selected="false" tabindex="-1" role="tab" href="javascript:void(0);" aria-live="assertive">
                            <span class="slds-tabs--path__stage AM_categToAppend2"></span>   
                            <span  class="slds-tabs--path__title AM_categToAppend2"></span>
                        </a>
                      </li>  
                      <div class="slds-dropdown-trigger slds-dropdown-trigger--click slds-is-open">
                      <!-- <button id="AM_next" class="slds-button slds-button--brand slds-path__mark-complete slds-no-flex slds-m-horizontal--small slds-hide" onClick="checkOut()">{!$Label.ITA_IFM_AM_Next}</button>  -->
                      <button id="AM_cart" class="slds-grid slds-button slds-button--brand slds-no-flex slds-m-horizontal--small" onClick="openCartSummary()"> 
                            <i class="fa fa-2x fa-shopping-cart"></i> 
                            <p id="AM_prodInCart">(0)</p>
                      </button>  
                      </div>   

                    </ul>               
                </div>  
            </div> 
        </div>
		<!-- ######################################################### --> 
	    <!--                          CART SUMMARY                     -->   
	    <!-- ######################################################### --> 
        <div id="AM_summarySection" class="slds-dropdown slds-dropdown--right slds-nubbin--top-right slds-medium-size--2-of-6 slds-large-size--3-of-12 slds-hide">
            <div> 
                <ul id="AM_cartSummary" class="slds-has-dividers--bottom-space"></ul>  
                <div  id="AM_cartMsg" class="slds-hide"></div> 
                <div id="AM_total">
                    <div id="AM_configurationStatus" class="slds-grid slds-grid slds-grid--align-end"></div>
                    <div class="slds-grid slds-grid slds-grid--align-end"><h3 id="AM_one" class="slds-section__title"></h3></div>
                    <div class="slds-grid slds-grid slds-grid--align-end"><h3 id="AM_recurring" class="slds-section__title"></h3></div>
                </div>
                <div class="slds-grid slds-grid--align-center">  
                    <button id="AM_resetButton" class="slds-button slds-button--neutral" onClick="resetCart()">{!$Label.ITA_IFM_AM_ResetCart}</button>
                    <button id="AM_checkOutButton" class="slds-button AM_disabled" onClick="checkOut()">{!$Label.ITA_IFM_AM_CheckOut}</button>
                </div>
            </div>
        </div>  
		<!-- ################################################################################# -->
		<!--                                FORM SEARCH BAR                                    -->
		<!-- ################################################################################# -->
        <div id="AM_FilterDiv" class="slds-grid slds-medium-size--6-of-6 slds-large-size--12-of-12 "> 
            <div class="slds-form-element__control">
                    <button id="AM_Slide_Filter" class="slds-button" data-button="" onclick="openFilter()">  
                        <i class="fa fa-3x fa-filter"></i>
                    </button>
            </div>
            <div class="slds-form-element__control"> 
                    <div id="AM_searchDiv" class="slds-input-has-icon slds-input-has-icon--right"> 
                        <input id="AM_searchBar" class="slds-lookup__search-input slds-input" type="search" placeholder="{!$Label.ITA_IFM_AM_Search}" aria-owns="lookup-330" role="combobox" aria-activedescendent="" aria-expanded="false" aria-autocomplete="list" onkeyup="searchProduct()" />
                    </div>
            </div>   
            <div class="slds-form-element__control">
                <button id="AM_reset" class="slds-button" onClick="resetFilter()">                
                    <i class="fa fa-3x fa-refresh"></i>
                </button> 
            </div> 
        </div>  
		<!-- ################################################################################# -->
		<!--                                   	BODY                                           -->
		<!-- ################################################################################# -->
        <div id="AM_body" class="slds-grid"> 
            <!-- ################################################################################# -->
			<!--                               BODY - LEFT SIDE                                    -->
			<!-- ################################################################################# -->
            <div id="AM_leftSection" class="slds-medium-size--2-of-6 slds-large-size--3-of-12 " style="display:none">  
                <!-- ################################################################################# -->
				<!--                                  FORM FILTRO                                      -->
				<!-- ################################################################################# -->                                
                <div class="slds-scrollable--y">     
                    <table id="AM_rightTab" class="slds-table slds-table--bordered slds-table--cell-buffer">
                        <tbody id="AM_Tab">
                            <tr>
                                <th scope="row">   
                                    <div class="slds-truncate">
                                        <a id="home" href="javascript:void(0);" onclick="getCategories(this.id)">{!$Label.ITA_IFM_AM_Residenziale}</a>
                                    </div>
                                </th>
                            </tr>
                            <tr>
                                <th scope="row">
                                    <div class="slds-truncate">
                                        <a id="business" href="javascript:void(0);" onclick="getCategories(this.id)">{!$Label.ITA_IFM_AM_Business}</a>
                                    </div>
                                </th> 
                            </tr>  
                            <tr>
                                <th scope="row">
                                    <div class="slds-truncate">
                                        <a id="serviziPartner" href="javascript:void(0);" onclick="getCategories(this.id)">{!$Label.ITA_IFM_AM_ServiziPartner}</a>
                                    </div>
                                </th> 
                            </tr>  
                            <tr>
                                <th scope="row">
                                    <div class="slds-truncate">
                                        <a id="kitLed" href="javascript:void(0);" onclick="getCategories(this.id)">{!$Label.ITA_IFM_AM_KitLed}</a>
                                    </div>
                                </th> 
                            </tr>    
                        </tbody>  
                    </table> 
                    <div id="AM_filterList" class="slds-form-element AM_dispNone" ></div>  
                </div>
                <div id="AM_warnMsg" class="slds-form-element AM_dispNone" ><p>{!$Label.ITA_IFM_AM_WarMessage}</p></div>  
            </div> 
            <!-- ################################################################################# -->
			<!--                                     CAROUSEL                                      -->
			<!-- ################################################################################# -->      
            <div id="AM_rightSection" class="slds-medium-size--6-of-6 slds-large-size--12-of-12">
                <div id="AM_Vetrina">  
                    <div id="AM_owl_containerAll" style="opacity: 1; display: block; width: 1px; min-width: 100%;"></div>  
                </div> 
            </div>          
        </div>  
		<!-- ################################################################################# -->
		<!--                                PRODUCT DETAIL                                     -->
		<!-- ################################################################################# -->         
        <div id="AM_productDetail" class="AM_dispNone">
             <div class="slds-grid ">
                <div class="slds-page-header slds-p-horizontal--small slds-size--1-of-1 slds-medium-size--6-of-6 slds-large-size--12-of-12 AM_productDetHeader" role="banner">
                    <div class="slds-media slds-media--center">
                        <div id="AM_ProduImg" class="slds-media__figure"></div>
                        <div id="AM_ProdName" class="slds-media__body"></div> 
                    </div>
                </div>
             </div>
             <div class="slds-grid">
                <div class="slds-tabs--scoped slds-medium-size--6-of-6 slds-large-size--12-of-12">
                    <ul class="slds-tabs--scoped__nav" role="tablist"> 
                        <li id="AM_Details" class="slds-tabs--scoped__item slds-text-title--caps slds-active" title="Item Two" role="presentation" onClick="changeTab(this.id)">
                            <a class="slds-tabs--scoped__link" href="javascript:void(0);" role="tab" tabindex="-1" aria-selected="false" aria-controls="tab-scoped-2" id="tab-scoped-2__item" >{!$Label.ITA_IFM_AM_Detail}</a>
                        </li>     
                        <li id="AM_Services" class="slds-tabs--scoped__item slds-text-title--caps" title="Item One" role="presentation" onClick="changeTab(this.id)">
                            <a class="slds-tabs--scoped__link" href="javascript:void(0);" role="tab" tabindex="0" aria-selected="true" aria-controls="tab-scoped-1" id="tab-scoped-1__item" >{!$Label.ITA_IFM_AM_Services}</a>
                        </li>                        
                    </ul>
                    <!-- ################################################################################# -->
					<!--                                        DETAILS                                    -->
					<!-- ################################################################################# -->   
                    <div id="AM_Details_div" class="slds-tabs--scoped__content slds-show" role="tabpanel" aria-labelledby="tab-scoped-2__item">
                        <div id="AM_documentToAppend" class="slds-grid"></div> 
                            <div class="slds-grid slds-grid--align-end"> 
                                <button id="AM_aggiungi" class="slds-button slds-button--brand" onclick="addProdFromDetail()">
                                	{!$Label.ITA_IFM_AM_Aggiungi}<i class="fa fa-shopping-cart fa-2x slds-icon"></i>
                                </button>  
                            </div>
                    </div>
                    <!-- ################################################################################# -->
					<!--                                        SERVICES                                   -->
					<!-- ################################################################################# -->  
                    <div id="AM_Services_div" class="slds-tabs--scoped__content slds-hide" role="tabpanel" aria-labelledby="tab-scoped-1__item"> 
                        <div> 
                            <div id="AM_serviceCarousel" style="opacity: 1; display: block;"></div> 
                        </div>
                    </div>  
                </div>    
            </div>
             
            <!-- ################################################################################# -->
			<!--                                         MODALS                                    -->
			<!-- ################################################################################# -->         
            <div role="dialog" tabindex="-1" aria-labelledby="header43" class="slds-modal AM_dispNone">
                <div class="slds-modal__container">
                    <div class="slds-modal__header">
                      <button class="slds-button slds-modal__close slds-button--icon-inverse" onClick="closeModal()">
                        <img class="slds-icon" src="{!URLFOR($Resource.NELightningResource, '/assets/icons/utility/close_60.png')}"/>
                      </button>
                      <h2 id="header43" class="slds-text-heading--medium">Modal Header</h2>
                    </div>
                    <div class="slds-modal__content slds-p-around--medium">
                      <div>
                        <p>Sit nulla est ex deserunt exercitation anim occaecat. Nostrud ullamco deserunt aute id consequat veniam incididunt duis in sint irure nisi. Mollit officia cillum Lorem ullamco minim nostrud elit officia tempor esse quis. Cillum sunt ad dolore
                          quis aute consequat ipsum magna exercitation reprehenderit magna. Tempor cupidatat consequat elit dolor adipisicing.</p>
                        <p>Dolor eiusmod sunt ex incididunt cillum quis nostrud velit duis sit officia. Lorem aliqua enim laboris do dolor eiusmod officia. Mollit incididunt nisi consectetur esse laborum eiusmod pariatur proident. Eiusmod et adipisicing culpa deserunt
                          nostrud ad veniam nulla aute est. Labore esse esse cupidatat amet velit id elit consequat minim ullamco mollit enim excepteur ea.</p>
                      </div>
                    </div>
                  </div>
                </div>
            <div class="slds-backdrop slds-backdrop--open AM_dispNone"></div>          
        </div>
	    <!-- ################################################################################# -->
		<!--                                         CART                                      -->
		<!-- ################################################################################# -->  
	    <div id="AM_CartSection" class="slds-hide">
	        <div class="slds-tabs--scoped"> 
	                <ul class="slds-tabs--scoped__nav" role="tablist">
	                    <li id="AM_itemOne" class="slds-tabs--scoped__item slds-text-title--caps slds-active" title="Item One" role="presentation" onclick="openConfigurationTab()">
	                        <a class="slds-tabs--scoped__link" href="javascript:void(0);" role="tab" tabindex="0" aria-selected="true" aria-controls="tab-scoped-1" id="tab-scoped-1__item">{!$Label.ITA_IFM_AM_Configuration}</a>
	                    </li>
	                    <li id="AM_itemTwo" class="slds-tabs--scoped__item slds-text-title--caps" title="Item Two" role="presentation" onclick="openSummary()">
	                        <a id="AM_prodSummary" class="slds-tabs--scoped__link" href="javascript:void(0);" role="tab" tabindex="-1" aria-selected="false" aria-controls="tab-scoped-2"></a> 
	                    </li>  
	                </ul>
	                <div id="tab-scoped-1" class="slds-tabs--scoped__content slds-show" role="tabpanel" aria-labelledby="tab-scoped-1__item"> 
	                    <article id="AM_configurationContainer" class="slds-card"> 
	                        <div class="AM_backgroundGrey slds-grid slds-medium-size--6-of-6 slds-large-size--12-of-12">
	                            <div id="AM_configurationProd" class="slds-grid slds-medium-size--2-of-6 slds-large-size--5-of-12"></div>  
	                            <div id="AM_configurationSave" class="slds-grid slds-medium-size--4-of-6 slds-large-size--7-of-12"> 
	                        		<div class="AM_buttonGroup slds-grid slds-button-group slds-dropdown-trigger slds-is-open"> 
	                                    <button class="slds-button slds-button--neutral slds-align--absolute-center" id="AM_msg" onclick="openEnvelopeMessages()">    
	                                    	<i class="fa fa-2x fa-exclamation AM_colorRed slds-hide"></i>
	                                        <i class="fa fa-2x fa-envelope-o"></i>
	                                        <p id="AM_envelopeMsg">(0)</p>
	                                    </button>
	                                    <button id="AM_confStatus"  class="slds-button slds-button--neutral slds-align--absolute-center">  
	                                        <p id="AM_esitoStatus">{!$Label.ITA_IFM_AM_ConfigurationStatus}:&nbsp; </p> 
	                                    </button> 
	                                    <button class="slds-button slds-button--neutral slds-align--absolute-center" id="AM_abort" onclick="abortConfiguration()">
	                                    {!$Label.ITA_IFM_AM_Cancel}
	                                    </button> 
	                                    <button class="slds-button slds-button--brand slds-button--last slds-align--absolute-center" id="AM_next" onclick="saveConfiguration()">
	                                    {!$Label.ITA_IFM_AM_Save}
	                                    </button> 
	                                    <div id="AM_envelopeMsg_section" class="slds-dropdown slds-dropdown--left slds-hide">
		                                    <div id="AM_divMessageList" >
		                                        <ul id="AM_messageList" class="slds-has-dividers--bottom-space"></ul>
		                                    </div>
	                            		</div> 
	                                </div>  
	                            </div>  
	                        </div>
	                        <div id="AM_configurationSection" class="slds-grid">
	                            <div id="AM_leftNavBar" class="slds-medium-size--3-of-6 slds-large-size--5-of-12 slds-grid slds-grid--vertical"></div>
	                            <div id="AM_leftSide" class="slds-medium-size--3-of-6 slds-large-size--7-of-12"> 
	                                <div id="AM_attributesContainer"> 
	                                    <ul id="AM_attributesDiv" class="slds-has-dividers--bottom-space"></ul> 
	                                </div>
	                                <div id="AM_childAttrContent" class="slds-hide"></div> 
	                            </div>                           
	                        </div>
	                    </article>
	                </div> 
	            <div id="tab-scoped-2" class="slds-tabs--scoped__content slds-hide" role="tabpanel" aria-labelledby="tab-scoped-2__item">
	                <div id="AM_summaryContainer"></div>
	            </div>  
	        </div>  
	    </div>  
		<!-- ######################################################################################################################### --> 
		<!--                                                        APEX FORM                                                          -->
		<!-- ######################################################################################################################### --> 
	    <apex:form >
	        <apex:actionFunction name="redirectToPage" action="{!redirectToPage}" status="spinner" reRender="dummys">
	            <apex:param name="paramId" value="" assignTo="{!quoteIdCreated}"/> 
	        </apex:actionFunction> 
	        <apex:actionFunction name="backToHome" action="{!backToHomePage}" status="spinner" reRender="dummy"></apex:actionFunction>
	        <apex:actionStatus onstart="startLoading();" onstop="endLoading();" id="spinner" />
	    </apex:form> 
	    <!-- ################################################################################# -->
		<!--                                         FOOTER                                    -->
		<!-- ################################################################################# -->
	    <div id="AM_footer-id">
	        <c:ITA_IFM_C043_AM_Footer stepNumber="1"/>
	    </div>
    </div>
</apex:page>